<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - STAR Online Shopping Platform</title>
  <link rel="stylesheet" type="text/css" href="./css/style.css">
  <style>
    :root{--primary:#ff6700;--bg:#f7f8fa;--card:#fff;--text:#2c3e50;--muted:#6b7280;--border:#e5e7eb}
    [data-theme="dark"]{--bg:#0f172a;--card:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937}
    body{background:var(--bg);color:var(--text)}
    .page-wrap{max-width:1100px;margin:0 auto;padding:24px}
    .header-row{display:flex;justify-content:space-between;align-items:center;margin:12px auto 0;max-width:1100px;padding:0 24px}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);text-decoration:none;transition:.2s;cursor:pointer}
    .btn:hover{border-color:#cbd5e1;transform:translateY(-1px)}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .card-header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
    .card-body{padding:16px}
    .avatar{width:96px;height:96px;border-radius:50%;border:2px solid var(--border);object-fit:cover}
    .row{display:flex;gap:14px;align-items:center}
    .row.space{justify-content:space-between}
    .muted{color:var(--muted)}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .field label{font-size:13px;color:var(--muted)}
    .field input,.field textarea,.field select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
    #nickname-input{width:180px}
    .field textarea{min-height:92px}
    #province-select,#city-select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#fde68a;color:#8a5a00;font-size:12px}
    .section-title{font-weight:600;margin-bottom:10px}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .list .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card)}
    .list .chip{color:var(--text) !important}
    .switch{position:relative;width:48px;height:26px;border-radius:999px;background:#d1d5db;border:1px solid var(--border);cursor:pointer}
    .switch[data-on="true"]{background:var(--primary)}
    .switch .knob{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#fff;transition:.2s}
    .switch[data-on="true"] .knob{left:24px}
    .status{padding:10px 12px;border-radius:10px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
    .header-row .actions .btn{padding:8px 12px}
    .avatar{background:#f3f4f6}
  </style>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      const html=document.documentElement
      const avatarImg=document.getElementById('avatar-img')
      const avatarInput=document.getElementById('avatar-input')
      const themeSwitch=document.getElementById('theme-switch')
      const provinceSelect=document.getElementById('province-select')
      const citySelect=document.getElementById('city-select')
      const addressDetail=document.getElementById('address-detail')
      const nicknameInput=document.getElementById('nickname-input')
      const saveProfileBtn=document.getElementById('save-profile')
      const logoutBtn=document.getElementById('logout-btn')
      const loginStatus=document.getElementById('login-status')
      const hint=document.getElementById('hint-text')

      const ls=(k,v)=>{if(v===undefined){return localStorage.getItem(k)}localStorage.setItem(k,v)}
      const theme=ls('profile.theme')||'light'
      html.setAttribute('data-theme',theme)
      themeSwitch.dataset.on=theme==='dark'?"true":"false"

      let uid=null
      let serverNickname=null
      let serverAvatarUrl=null
      const AREAS={
        '北京市':['北京市'],
        '上海市':['上海市'],
        '天津市':['天津市'],
        '重庆市':['重庆市'],
        '河北省':['石家庄市','唐山市','秦皇岛市','邯郸市','邢台市','保定市','张家口市','承德市','沧州市','廊坊市','衡水市'],
        '山西省':['太原市','大同市','阳泉市','长治市','晋城市','朔州市','晋中市','运城市','忻州市','临汾市','吕梁市'],
        '辽宁省':['沈阳市','大连市','鞍山市','抚顺市','本溪市','丹东市','锦州市','营口市','阜新市','辽阳市','盘锦市','铁岭市','朝阳市','葫芦岛市'],
        '吉林省':['长春市','吉林市','四平市','辽源市','通化市','白山市','松原市','白城市','延边州'],
        '黑龙江省':['哈尔滨市','齐齐哈尔市','牡丹江市','佳木斯市','大庆市','伊春市','鸡西市','鹤岗市','双鸭山市','七台河市','黑河市','绥化市','大兴安岭地区'],
        '江苏省':['南京市','无锡市','徐州市','常州市','苏州市','南通市','连云港市','淮安市','盐城市','扬州市','镇江市','泰州市','宿迁市'],
        '浙江省':['杭州市','宁波市','温州市','嘉兴市','湖州市','绍兴市','金华市','衢州市','舟山市','台州市','丽水市'],
        '安徽省':['合肥市','芜湖市','蚌埠市','淮南市','马鞍山市','淮北市','铜陵市','安庆市','黄山市','滁州市','阜阳市','宿州市','六安市','亳州市','池州市','宣城市'],
        '福建省':['福州市','厦门市','莆田市','三明市','泉州市','漳州市','南平市','龙岩市','宁德市'],
        '江西省':['南昌市','景德镇市','萍乡市','九江市','新余市','鹰潭市','赣州市','吉安市','宜春市','抚州市','上饶市'],
        '山东省':['济南市','青岛市','淄博市','枣庄市','东营市','烟台市','潍坊市','济宁市','泰安市','威海市','日照市','临沂市','德州市','聊城市','滨州市','菏泽市'],
        '河南省':['郑州市','开封市','洛阳市','平顶山市','安阳市','鹤壁市','新乡市','焦作市','濮阳市','许昌市','漯河市','三门峡市','南阳市','商丘市','信阳市','周口市','驻马店市'],
        '湖北省':['武汉市','黄石市','十堰市','宜昌市','襄阳市','鄂州市','荆门市','孝感市','荆州市','黄冈市','咸宁市','随州市','恩施州'],
        '湖南省':['长沙市','株洲市','湘潭市','衡阳市','邵阳市','岳阳市','常德市','张家界市','益阳市','郴州市','永州市','怀化市','娄底市','湘西州'],
        '广东省':['广州市','深圳市','珠海市','汕头市','佛山市','韶关市','湛江市','肇庆市','江门市','茂名市','惠州市','梅州市','汕尾市','河源市','阳江市','清远市','东莞市','中山市','潮州市','揭阳市','云浮市'],
        '海南省':['海口市','三亚市','三沙市','儋州市'],
        '四川省':['成都市','自贡市','攀枝花市','泸州市','德阳市','绵阳市','广元市','遂宁市','内江市','乐山市','南充市','眉山市','宜宾市','广安市','达州市','雅安市','巴中市','资阳市','阿坝州','甘孜州','凉山州'],
        '贵州省':['贵阳市','六盘水市','遵义市','安顺市','毕节市','铜仁市','黔西南州','黔东南州','黔南州'],
        '云南省':['昆明市','曲靖市','玉溪市','保山市','昭通市','丽江市','普洱市','临沧市','楚雄州','红河州','文山州','西双版纳州','大理州','德宏州','怒江州','迪庆州'],
        '陕西省':['西安市','铜川市','宝鸡市','咸阳市','渭南市','延安市','汉中市','榆林市','安康市','商洛市'],
        '甘肃省':['兰州市','嘉峪关市','金昌市','白银市','天水市','武威市','张掖市','平凉市','酒泉市','庆阳市','定西市','陇南市','临夏州','甘南州'],
        '青海省':['西宁市','海东市','海北州','黄南州','海南州','果洛州','玉树州','海西州'],
        '台湾省':['台北市','新北市','桃园市','台中市','台南市','高雄市'],
        '内蒙古自治区':['呼和浩特市','包头市','乌海市','赤峰市','通辽市','鄂尔多斯市','呼伦贝尔市','巴彦淖尔市','乌兰察布市','兴安盟','锡林郭勒盟','阿拉善盟'],
        '广西壮族自治区':['南宁市','柳州市','桂林市','梧州市','北海市','防城港市','钦州市','贵港市','玉林市','百色市','贺州市','河池市','来宾市','崇左市'],
        '宁夏回族自治区':['银川市','石嘴山市','吴忠市','固原市','中卫市'],
        '新疆维吾尔自治区':['乌鲁木齐市','克拉玛依市','吐鲁番市','哈密市','昌吉州','博尔塔拉州','巴音郭楞州','阿克苏地区','克孜勒苏州','喀什地区','和田地区','伊犁州','塔城地区','阿勒泰地区'],
        '西藏自治区':['拉萨市','日喀则市','昌都市','林芝市','山南市','那曲市','阿里地区'],
        '香港特别行政区':['香港'],
        '澳门特别行政区':['澳门']
      }
      const fillProvinces=()=>{
        provinceSelect.innerHTML=''
        Object.keys(AREAS).forEach(p=>{const opt=document.createElement('option');opt.value=p;opt.textContent=p;provinceSelect.appendChild(opt)})
      }
      const fillCities=(p)=>{
        citySelect.innerHTML=''
        const list=AREAS[p]||[]
        list.forEach(c=>{const opt=document.createElement('option');opt.value=c;opt.textContent=c;citySelect.appendChild(opt)})
      }
      const DEFAULT_AVATAR_URL='./image/initial.png'
      const getKey=(n)=>uid?`profile.${n}.${uid}`:`profile.${n}`
      const init=()=>{
        const nick=ls(getKey('nickname'))||''
        const addrRaw=ls(getKey('address'))||''
        let addrObj={province:'',city:'',detail:''}
        try{const j=JSON.parse(addrRaw);addrObj={province:j.province||'',city:j.city||'',detail:j.detail||''}}catch(e){addrObj.detail=addrRaw}
        const av=ls(getKey('avatar'))||''
        if(nicknameInput) nicknameInput.value=serverNickname||nick
        fillProvinces()
        const initialProv=addrObj.province||Object.keys(AREAS)[0]
        provinceSelect.value=initialProv
        fillCities(initialProv)
        citySelect.value=addrObj.city||citySelect.options[0]?.value||''
        if(addressDetail) addressDetail.value=addrObj.detail||''
        avatarImg.src=serverAvatarUrl||av||DEFAULT_AVATAR_URL
        avatarImg.onerror=()=>{avatarImg.src=DEFAULT_AVATAR_URL}
      }
      try{
        fetch('/auth/me').then(r=>r.ok?r.json():null).then(u=>{uid=u?(u.user_id||u.id):null;serverAvatarUrl=u&&u.avatar_url?u.avatar_url:null;serverNickname=u&&u.username?u.username:null}).finally(()=>init())
      }catch(e){init()}

      if(provinceSelect){
        provinceSelect.addEventListener('change',()=>{
          const p=provinceSelect.value
          fillCities(p)
        })
      }

      themeSwitch.addEventListener('click',()=>{
        const on=themeSwitch.dataset.on!=="true"
        themeSwitch.dataset.on=on?"true":"false"
        const t=on?'dark':'light'
        html.setAttribute('data-theme',t)
        ls('profile.theme',t)
      })

      if(avatarInput){
        avatarInput.addEventListener('change',async e=>{
          const file=e.target.files&&e.target.files[0]
          if(!file) return
          if(uid){
            try{
              const fd=new FormData();
              fd.append('avatar',file)
              const r=await fetch('/auth/avatar',{method:'POST',body:fd})
              if(r.ok){
                const data=await r.json()
                if(data&&data.url){
                  serverAvatarUrl=data.url
                  avatarImg.src=serverAvatarUrl
                  const toast=document.getElementById('avatar-toast')
                  toast.textContent='Avatar uploaded successfully'
                  toast.style.opacity='1'
                  setTimeout(()=>{toast.style.opacity='0'},1200)
                  ls(getKey('avatar'),serverAvatarUrl)
                  return
                }
              }
            }catch(err){}
          }
          const reader=new FileReader()
          reader.onload=()=>{
            avatarImg.src=reader.result||DEFAULT_AVATAR_URL
            const toast=document.getElementById('avatar-toast')
            toast.textContent='Avatar updated'
            toast.style.opacity='1'
            setTimeout(()=>{toast.style.opacity='0'},1200)
            ls(getKey('avatar'),reader.result||'')
          }
          reader.readAsDataURL(file)
        })
      }

      if(saveProfileBtn){
        saveProfileBtn.addEventListener('click',async()=>{
          const nn=nicknameInput.value.trim()
          ls(getKey('nickname'),nn)
          const stored=JSON.stringify({province:provinceSelect.value||'',city:citySelect.value||'',detail:addressDetail.value.trim()||''})
          ls(getKey('address'),stored)
          try{
            if(uid){
              await fetch('/auth/nickname',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({nickname:nn})})
            }
          }catch(err){}
          const toast=document.getElementById('save-toast')
          toast.style.opacity='1'
          setTimeout(()=>{toast.style.opacity='0'},1200)
        })
      }

      if(logoutBtn){
        logoutBtn.addEventListener('click',async()=>{
          try{
            const r=await fetch('/auth/logout',{method:'POST'})
            if(r.ok){window.location.href='/login.html'}
          }catch(e){}
        })
      }

      ;(async()=>{
        try{
          const r=await fetch('/orders',{method:'GET',redirect:'follow'})
          const logged=r.url&&r.url.includes('/orders')
          loginStatus.textContent=logged?'Logged in':'Not logged in'
          hint.textContent=logged?'Welcome back, you can manage profile and preferences':'You need to log in to access orders and cart features'
          logoutBtn.style.display=logged?'inline-flex':'none'
        }catch(err){
          loginStatus.textContent='Not logged in'
          hint.textContent='You need to log in to access orders and cart features'
          logoutBtn.style.display='none'
        }
      })()
    })
  </script>
  </head>
<body>
  <div class="banner_x">
    <div class="center-content">
      <a href="/homepage"><div class="logo fl"></div></a>
    </div>
  </div>

  <div class="header-row">
    <div class="row">
      <div class="pill">Profile</div>
    </div>
    <div class="actions">
      <a class="btn" href="/products/all">Browse Products</a>
      <a class="btn" href="/cart">My Cart</a>
      <a class="btn primary" href="/orders">My Orders</a>
      <button class="btn" id="logout-btn">Log Out</button>
    </div>
  </div>

  <div class="page-wrap">
    <div class="status" style="margin-bottom:12px">Login Status: <span id="login-status">Checking</span></div>
    <div class="grid">
      <div class="card">
        <div class="card-header">Account Information</div>
        <div class="card-body">
          <div class="row space" style="margin-bottom:14px">
            <div class="row" style="gap:16px;align-items:flex-start">
              <img id="avatar-img" class="avatar" src="./image/initial.png" alt="">
              <div style="min-width:260px">
                <div class="field"><label>Nickname</label><input id="nickname-input" placeholder="Enter nickname"></div>
                <label class="btn" style="cursor:pointer;margin-top:6px">Change Avatar<input id="avatar-input" type="file" accept="image/*" style="display:none"></label>
              </div>
            </div>
          </div>
          <div class="field"><label>Shipping Address</label>
            <div class="row" style="gap:8px;align-items:center">
              <select id="province-select"></select>
              <select id="city-select"></select>
            </div>
            <textarea id="address-detail" placeholder="Detailed address"></textarea>
          </div>
          <div class="row space" style="margin-top:8px">
            <button class="btn primary" id="save-profile">Save</button>
            <div id="save-toast" style="transition:.2s;opacity:0" class="muted">Saved locally</div>
            <div id="avatar-toast" style="transition:.2s;opacity:0" class="muted">Avatar uploaded successfully</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Preferences</div>
        <div class="card-body">
          <div class="row space" style="margin-bottom:12px">
            <div>
              <div class="section-title">Theme</div>
              <div class="muted">Toggle light/dark theme (this device only)</div>
            </div>
            <div class="switch" id="theme-switch" data-on="false"><div class="knob"></div></div>
          </div>
          <div class="section-title">Common Actions</div>
          <div class="list" style="margin-top:8px">
            <a class="chip" href="/homepage">Back to Home</a>
            <a class="chip" href="/products/all">Browse Products</a>
            <a class="chip" href="/orders">View Orders</a>
          </div>
          <div class="muted" id="hint-text" style="margin-top:12px">Tip: You need to log in to access orders.</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
