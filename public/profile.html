<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>个人中心 - STAR在线购物平台</title>
  <link rel="stylesheet" type="text/css" href="./css/style.css">
  <style>
    :root{--primary:#ff6700;--bg:#f7f8fa;--card:#fff;--text:#2c3e50;--muted:#6b7280;--border:#e5e7eb}
    [data-theme="dark"]{--bg:#0f172a;--card:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937}
    body{background:var(--bg);color:var(--text)}
    .page-wrap{max-width:1100px;margin:0 auto;padding:24px}
    .header-row{display:flex;justify-content:space-between;align-items:center;margin:12px auto 0;max-width:1100px;padding:0 24px}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);text-decoration:none;transition:.2s;cursor:pointer}
    .btn:hover{border-color:#cbd5e1;transform:translateY(-1px)}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .card-header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
    .card-body{padding:16px}
    .avatar{width:96px;height:96px;border-radius:50%;border:2px solid var(--border);object-fit:cover}
    .row{display:flex;gap:14px;align-items:center}
    .row.space{justify-content:space-between}
    .muted{color:var(--muted)}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .field label{font-size:13px;color:var(--muted)}
    .field input,.field textarea,.field select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .field textarea{min-height:92px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#fde68a;color:#8a5a00;font-size:12px}
    .section-title{font-weight:600;margin-bottom:10px}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .list .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card)}
    .switch{position:relative;width:48px;height:26px;border-radius:999px;background:#d1d5db;border:1px solid var(--border);cursor:pointer}
    .switch[data-on="true"]{background:var(--primary)}
    .switch .knob{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#fff;transition:.2s}
    .switch[data-on="true"] .knob{left:24px}
    .status{padding:10px 12px;border-radius:10px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
    .header-row .actions .btn{padding:8px 12px}
    .avatar{background:#f3f4f6}
  </style>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      const html=document.documentElement
      const avatarImg=document.getElementById('avatar-img')
      const avatarInput=document.getElementById('avatar-input')
      const themeSwitch=document.getElementById('theme-switch')
      const addressInput=document.getElementById('address-input')
      const nicknameInput=document.getElementById('nickname-input')
      const saveProfileBtn=document.getElementById('save-profile')
      const logoutBtn=document.getElementById('logout-btn')
      const loginStatus=document.getElementById('login-status')
      const hint=document.getElementById('hint-text')

      const ls=(k,v)=>{if(v===undefined){return localStorage.getItem(k)}localStorage.setItem(k,v)}
      const theme=ls('profile.theme')||'light'
      html.setAttribute('data-theme',theme)
      themeSwitch.dataset.on=theme==='dark'?"true":"false"

      let uid=null
      const DEFAULT_AVATAR_URL='./image/initial.png'
      const getKey=(n)=>uid?`profile.${n}.${uid}`:`profile.${n}`
      const init=()=>{
        const nick=ls(getKey('nickname'))||''
        const addr=ls(getKey('address'))||''
        const av=ls(getKey('avatar'))||''
        if(nicknameInput) nicknameInput.value=nick
        if(addressInput) addressInput.value=addr
        avatarImg.src=av||DEFAULT_AVATAR_URL
        avatarImg.onerror=()=>{avatarImg.src=DEFAULT_AVATAR_URL}
      }
      try{
        fetch('/auth/me').then(r=>r.ok?r.json():null).then(u=>{uid=u?(u.user_id||u.id):null}).finally(()=>init())
      }catch(e){init()}

      themeSwitch.addEventListener('click',()=>{
        const on=themeSwitch.dataset.on!=="true"
        themeSwitch.dataset.on=on?"true":"false"
        const t=on?'dark':'light'
        html.setAttribute('data-theme',t)
        ls('profile.theme',t)
      })

      if(avatarInput){
        avatarInput.addEventListener('change',e=>{
          const file=e.target.files&&e.target.files[0]
          if(!file) return
          const reader=new FileReader()
          reader.onload=()=>{
            avatarImg.src=reader.result||DEFAULT_AVATAR_URL
            ls(getKey('avatar'),reader.result||'')
          }
          reader.readAsDataURL(file)
        })
      }

      if(saveProfileBtn){
        saveProfileBtn.addEventListener('click',()=>{
          ls(getKey('nickname'),nicknameInput.value.trim())
          ls(getKey('address'),addressInput.value.trim())
          const toast=document.getElementById('save-toast')
          toast.style.opacity='1'
          setTimeout(()=>{toast.style.opacity='0'},1200)
        })
      }

      if(logoutBtn){
        logoutBtn.addEventListener('click',async()=>{
          try{
            const r=await fetch('/auth/logout',{method:'POST'})
            if(r.ok){window.location.href='/login.html'}
          }catch(e){}
        })
      }

      ;(async()=>{
        try{
          const r=await fetch('/orders',{method:'GET',redirect:'follow'})
          const logged=r.url&&r.url.includes('/orders')
          loginStatus.textContent=logged?'已登录':'未登录'
          hint.textContent=logged?'欢迎回来，您可以管理个人信息与偏好设置':'访问订单与购物车等功能需要先登录'
          logoutBtn.style.display=logged?'inline-flex':'none'
        }catch(err){
          loginStatus.textContent='未登录'
          hint.textContent='访问订单与购物车等功能需要先登录'
          logoutBtn.style.display='none'
        }
      })()
    })
  </script>
  </head>
<body>
  <div class="banner_x">
    <div class="center-content">
      <a href="/homepage"><div class="logo fl"></div></a>
    </div>
  </div>

  <div class="header-row">
    <div class="row">
      <div class="pill">个人中心</div>
    </div>
    <div class="actions">
      <a class="btn" href="/products/all">继续逛逛</a>
      <a class="btn" href="/cart">我的购物车</a>
      <a class="btn primary" href="/orders">我的订单</a>
      <button class="btn" id="logout-btn">退出登录</button>
    </div>
  </div>

  <div class="page-wrap">
    <div class="status" style="margin-bottom:12px">登录状态：<span id="login-status">检测中</span></div>
    <div class="grid">
      <div class="card">
        <div class="card-header">账户信息</div>
        <div class="card-body">
          <div class="row space" style="margin-bottom:14px">
            <div class="row" style="gap:16px;align-items:flex-start">
              <img id="avatar-img" class="avatar" src="./image/initial.png" alt="">
              <div style="min-width:260px">
                <div class="field"><label>昵称</label><input id="nickname-input" placeholder="输入昵称"></div>
                <label class="btn" style="cursor:pointer;margin-top:6px">更换头像<input id="avatar-input" type="file" accept="image/*" style="display:none"></label>
              </div>
            </div>
          </div>
          <div class="field"><label>收货地址</label><textarea id="address-input" placeholder="详细地址"></textarea></div>
          <div class="row space" style="margin-top:8px">
            <button class="btn primary" id="save-profile">保存</button>
            <div id="save-toast" style="transition:.2s;opacity:0" class="muted">已保存到本地</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">偏好设置</div>
        <div class="card-body">
          <div class="row space" style="margin-bottom:12px">
            <div>
              <div class="section-title">主题</div>
              <div class="muted">切换浅色/深色主题，仅当前设备生效</div>
            </div>
            <div class="switch" id="theme-switch" data-on="false"><div class="knob"></div></div>
          </div>
          <div class="section-title">常用功能</div>
          <div class="list" style="margin-top:8px">
            <a class="chip" href="/homepage">返回主页</a>
            <a class="chip" href="/products/all">浏览商品</a>
            <a class="chip" href="/orders">查看订单</a>
          </div>
          <div class="muted" id="hint-text" style="margin-top:12px">提示：访问订单需要先登录。</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>