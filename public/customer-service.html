<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>客服咨询</title>
  <link rel="stylesheet" href="./css/style.css" />
  <link rel="stylesheet" href="./css/customer-service.css" />
  <style></style>
  <script src="/js/cs-sky.js"></script>
  <script src="/js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const statusEl = document.getElementById('cs-status');
      const chatEl = document.getElementById('cs-chat');
      const inputEl = document.getElementById('cs-input');
      const sendBtn = document.getElementById('cs-send');
      const toastEl = document.getElementById('cs-toast');
      function fmtTime(){return new Date().toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'});}      
      function showToast(text){toastEl.textContent=text;toastEl.classList.add('show');setTimeout(()=>{toastEl.classList.remove('show');},2000);}      
      function addMsg(text, who){
        const row=document.createElement('div');
        row.className='cs-msg-row '+(who==='me'?'me':'srv');
        const avatar=document.createElement('div');
        avatar.className='cs-avatar '+(who==='me'?'me':'srv');
        avatar.textContent=who==='me'?'我':'客';
        const bubble=document.createElement('div');
        bubble.className='cs-bubble '+(who==='me'?'me':'srv');
        bubble.innerHTML=`<div>${text}</div><div class="cs-time">${fmtTime()}</div>`;
        if(who==='me'){row.appendChild(bubble);row.appendChild(avatar);}else{row.appendChild(avatar);row.appendChild(bubble);}        
        chatEl.appendChild(row);
        chatEl.scrollTop=chatEl.scrollHeight;
      }
      document.addEventListener('cs:status', function(ev){
        const { connected } = ev.detail || {};
        statusEl.classList.toggle('offline', !connected);
        statusEl.innerHTML = `${connected?'<span class="dot"></span>已连接':'<span class="dot"></span>未连接，自动重试中...'}`;
        sendBtn.disabled = false;
      });
      document.addEventListener('cs:message', function(ev){
        const msg = ev.detail || {};
        if (msg.type === 'reply'){ addMsg(msg.message || '客服回复', 'srv'); }
        if (msg.type === 'ack'){ showToast('已收到，我们会尽快回复'); }
        if (msg.type === 'reply' || msg.type === 'ack'){ if (window.__csSpawnMeteor) window.__csSpawnMeteor(); }
        if (msg.type === 'session_ended'){
          showToast('会话已结束');
          sendBtn.disabled = true;
          inputEl.disabled = true;
        }
      });
      function doSend(){
        const text=(inputEl.value||'').trim();
        if(!text) return;
        addMsg(text,'me');
        inputEl.value='';
        window.CustomerService.sendQuestion(text);
      }
      sendBtn.addEventListener('click', doSend);
      inputEl.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); doSend(); } });
      inputEl.addEventListener('focus', function(){ document.querySelector('.cs-chat')?.classList.add('focus'); });
      inputEl.addEventListener('blur', function(){ document.querySelector('.cs-chat')?.classList.remove('focus'); });

      (async () => {
        try {
          const sid = window.CustomerService.sessionId();
          const res = await fetch(`/api/customer-service/history/${sid}`);
          const data = await res.json();
          if (data && data.ok && Array.isArray(data.history)) {
            chatEl.innerHTML = '';
            data.history.forEach(h => { const who = h.sender === 'admin' ? 'srv' : (h.sender === 'system' ? 'srv' : 'me'); addMsg(h.content, who==='me'?'me':'srv'); });
          }
        } catch (_) {}
      })();
    });
  </script>
  </head>
<body>
  <div class="sky-bg"><div class="sky-layer"><canvas id="sky-stars"></canvas><canvas id="sky-meteors"></canvas></div></div>
  <div class="cs-container">
    <div class="cs-header">
      <div class="cs-title">客服咨询</div>
      <div class="cs-status"><span class="dot"></span><span id="cs-status">连接中...</span></div>
    </div>
    <div class="cs-body">
      <div style="margin-bottom:8px;font-size:12px;color:#6b7280">会话ID：<span id="cs-session"></span></div>
      <div class="cs-chat" id="cs-chat"></div>
      <div class="cs-form">
        <input id="cs-input" type="text" placeholder="请输入您的问题，比如“我想退货”" />
        <button id="cs-send" type="button">发送</button>
      </div>
      <div style="margin-top:10px;font-size:12px;color:#9ca3af">按 Enter 可快速发送</div>
      <div style="margin-top:12px">
        <a href="/login.html">返回登录</a> ｜ <a href="/homepage">返回首页</a>
      </div>
    </div>
  </div>
  <div class="cs-toast" id="cs-toast"></div>
  <script>
    document.getElementById('cs-session').textContent = window.CustomerService.sessionId();
  </script>
</body>
</html>
