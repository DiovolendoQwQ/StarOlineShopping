<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - STAR Online Shopping Platform</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <video autoplay muted loop id="background-video">
    <source src="Picture/login.mp4" type="video/mp4">
    Your browser does not support HTML5 video.
  </video>
  <header>
    <div class="header-container">
      <h1>STAR Online Shopping Platform</h1>
    </div>
  </header>

  <main>
    <!-- Login Section -->
    <section id="login">
      <h2>Login</h2>
      <form action="/login" method="post" class="login-form">
        <div class="form-group">
          <label for="email">Email Address:</label>
          <input type="email" id="email" name="email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" name="password" placeholder="Enter your password" required>
        </div>
        <div class="form-group">
          <button type="submit" class="login-button">Log In</button>
        </div>
        <div class="form-group">
          <p>Don't have an account? <a href="javascript:void(0);" onclick="showRegisterForm()">Sign up now</a></p>
        </div>
        <div class="error-message" id="login-error" style="display:none"></div>
      </form>
    </section>

    <!-- Register Section -->
    <section id="register" style="display: none;">
      <h2>Sign Up</h2>
      <form action="/register" method="post" class="register-form">
        <div class="form-group">
          <label for="register_username">Username:</label>
          <input type="text" id="register_username" name="register_username" placeholder="Enter your username" required>
        </div>
        <div class="form-group">
          <label for="register_email">Email Address:</label>
          <input type="email" id="register_email" name="register_email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="register_password">Password:</label>
          <input type="password" id="register_password" name="register_password" placeholder="Enter your password"
            required>
        </div>
        <div class="form-group">
          <label for="confirm_password">Confirm Password:</label>
          <input type="password" id="confirm_password" name="confirm_password" placeholder="Re-enter your password"
            required>
        </div>
        <div class="form-group">
          <button type="submit" class="register-button">Sign Up</button>
        </div>
        <div class="form-group">
          <p>Already have an account? <a href="javascript:void(0);" onclick="showLoginForm()">Log in now</a></p>
        </div>
      </form>
    </section>

    <footer>
      <div class="footer-container">
        <p>Copyright &copy; 2025 STAR Online Shopping Platform</p>
      </div>
    </footer>

    <!-- JavaScript to Toggle Forms -->
    <script>
      function showRegisterForm() {
        document.getElementById('login').style.display = 'none';
        document.getElementById('register').style.display = 'block';
      }

      function showLoginForm() {
        document.getElementById('login').style.display = 'block';
        document.getElementById('register').style.display = 'none';
      }

      // Sign-up form validation
      document.querySelector('.register-form').addEventListener('submit', function (event) {
        const password = document.getElementById('register_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;

        if (password !== confirmPassword) {
          event.preventDefault();
          alert('Passwords do not match. Please re-enter.');
        }
      });

      (function () {
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const emailLabel = document.querySelector('label[for="email"]');
        const passwordLabel = document.querySelector('label[for="password"]');
        const errorBox = document.getElementById('login-error');

        function clearErrors() {
          emailInput.classList.remove('input-error');
          passwordInput.classList.remove('input-error');
          emailLabel.classList.remove('label-error');
          passwordLabel.classList.remove('label-error');
          errorBox.style.display = 'none';
          errorBox.textContent = '';
        }

        document.querySelector('.login-form').addEventListener('submit', async function (event) {
          event.preventDefault();
          clearErrors();
          const form = event.target;
          const body = new URLSearchParams({
            email: emailInput.value.trim(),
            password: passwordInput.value
          });

          try {
            const resp = await fetch(form.action, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              },
              body
            });

            if (resp.ok) {
              const data = await resp.json();
              if (data && data.redirect) {
                window.location.href = data.redirect;
              } else {
                window.location.href = '/homepage';
              }
              return;
            }

            const data = await resp.json().catch(function () { return {}; });
            const code = data.error || '';
            let message = 'Incorrect email or password';
            if (code === 'invalid_user') {
              message = 'User not found. Please sign up or check the email address';
              emailInput.classList.add('input-error');
              emailLabel.classList.add('label-error');
            } else if (code === 'invalid_password') {
              message = 'Incorrect email or password';
              emailInput.classList.add('input-error');
              passwordInput.classList.add('input-error');
              emailLabel.classList.add('label-error');
              passwordLabel.classList.add('label-error');
            } else {
              message = 'Server error. Please try again later';
            }
            errorBox.textContent = message;
            errorBox.style.display = 'block';
          } catch (e) {
            errorBox.textContent = 'Network error. Please try again later';
            errorBox.style.display = 'block';
          }
        });

        emailInput.addEventListener('input', clearErrors);
        passwordInput.addEventListener('input', clearErrors);
      })();
    </script>
</body>

</html>