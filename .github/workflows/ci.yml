name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸ§ª æµ‹è¯•
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: ğŸ” ä»£ç æ£€æŸ¥
      run: |
        echo "è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥..."
        # npm run lint (å¦‚æœæœ‰é…ç½®)
    
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
        # npm test (å¦‚æœæœ‰é…ç½®)
    
    - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
      run: |
        echo "æ„å»ºé¡¹ç›®..."
        npm run build --if-present
    
    - name: ğŸ”„ æ•°æ®åº“è¿ç§»æµ‹è¯•
      run: |
        echo "æµ‹è¯•æ•°æ®åº“è¿ç§»..."
        npm run migrate --if-present

  security:
    name: ğŸ”’ å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: ğŸ›¡ï¸ å®‰å…¨å®¡è®¡
      run: npm audit --audit-level=moderate
    
    - name: ğŸ” ä¾èµ–æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–..."
        npm outdated || true

  deploy:
    name: ğŸš€ éƒ¨ç½²
    needs: [test, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
      run: |
        echo "æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
        npm run build --if-present
    
    - name: ğŸ“‹ ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "## ğŸš€ éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **çŠ¶æ€**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
    
    # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²æ­¥éª¤
    # - name: ğŸŒ éƒ¨ç½²åˆ°æœåŠ¡å™¨
    #   run: |
    #     echo "éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨..."
    #     # æ·»åŠ ä½ çš„éƒ¨ç½²å‘½ä»¤

  release:
    name: ğŸ“¦ å‘å¸ƒ
    needs: [test, security]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: ğŸ—ï¸ æ„å»ºå‘å¸ƒç‰ˆæœ¬
      run: |
        echo "æ„å»ºå‘å¸ƒç‰ˆæœ¬..."
        npm run build --if-present
    
    - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        echo "ç”Ÿæˆå‘å¸ƒè¯´æ˜..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜çš„é€»è¾‘
    
    - name: ğŸš€ åˆ›å»ºGitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: STAR åœ¨çº¿è´­ç‰©å¹³å° ${{ github.ref }}
        body: |
          ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒï¼
          
          æŸ¥çœ‹å®Œæ•´çš„æ›´æ–°å†…å®¹è¯·å‚è€ƒ [CHANGELOG.md](./CHANGELOG.md)
          
          ### ğŸ“¥ å®‰è£…æ–¹å¼
          ```bash
          git clone https://github.com/${{ github.repository }}.git
          cd STAR_Online_Shopping
          npm install
          npm start
          ```
          
          ### ğŸ“š ç›¸å…³æ–‡æ¡£
          - [ä½¿ç”¨æŒ‡å—](./README.md)
          - [å‘å¸ƒè¯´æ˜](./RELEASE_NOTES.md)
          - [è¿ç§»æŒ‡å—](./MIGRATION_GUIDE.md)
        draft: false
        prerelease: false