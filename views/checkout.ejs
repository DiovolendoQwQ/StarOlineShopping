<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>结算</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .checkout-page{max-width:1226px;margin:0 auto;padding:20px}
    .topbar{background:#fff;border-bottom:1px solid #eee;padding:0}
    .topbar .inner{max-width:1226px;margin:0 auto;padding:0 20px;height:100px;display:flex;align-items:center;justify-content:space-between;color:#333}
    .section{background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.08);margin-bottom:20px;overflow:hidden}
    .section-header{padding:16px 20px;font-weight:600;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;justify-content:space-between}
    .section-title{display:flex;align-items:center;gap:10px}
    .toggle{display:flex;align-items:center;gap:8px;cursor:pointer;color:#666}
    .toggle .icon{display:inline-block;transition:.2s ease}
    .section-body{padding:20px}
    .collapsible.collapsed .section-body{display:none}
    .collapsible.collapsed .toggle .icon{transform:rotate(-90deg)}
    .summary-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}
    .summary-item:last-child{border-bottom:none}
    .total-line{display:flex;justify-content:space-between;padding-top:10px;font-size:18px;font-weight:700;color:#e74c3c}
    .pay-methods{display:flex;gap:12px;flex-wrap:wrap}
    .pay-option{display:flex;align-items:center;gap:8px;padding:12px 16px;border:1px solid #e0e0e0;border-radius:8px;cursor:pointer}
    .pay-option.active{border-color:#ff6700;box-shadow:0 4px 12px rgba(255,103,0,.2)}
    .pay-content{margin-top:16px}
    .qr-box{display:none;align-items:center;gap:20px}
    .qr-box.active{display:flex}
    .qr-box img{width:220px;height:220px;border-radius:12px;border:1px solid #eee;object-fit:cover}
    .hint{color:#666;font-size:12px}
    .cc-form{display:none;gap:12px;max-width:520px}
    .cc-form.active{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .cc-form .full{grid-column:1 / -1}
    .cc-form label{font-size:12px;color:#666;margin-bottom:6px;display:block}
    .cc-form input{width:100%;height:40px;border:1px solid #ddd;border-radius:8px;padding:0 12px;font-size:14px}
    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px}
    .btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
    .btn-primary{background:#ff6700;color:#fff}
    .btn-primary:hover{background:#e55a00}
    .btn-secondary{background:#f5f5f5;color:#333}
  </style>
</head>
<body>
  <div class="topbar"><div class="inner"><div style="display:flex;align-items:center;gap:12px"><a href="/homepage"><div class="logo fl" style="width:200px;height:100px;background:url('/image/logo_top.jpg.png') no-repeat center center;background-size:contain"></div></a></div><a href="/cart" style="color:#333;text-decoration:none">返回购物车</a></div></div>
  <div class="checkout-page">
    <div class="section collapsible collapsed" id="summarySection">
      <div class="section-header"><div class="section-title">订单概要</div><div class="toggle" id="summaryToggle"><span class="icon">▶</span><span>展开</span><span style="margin-left:12px;color:#e74c3c">¥<%= totalAmount %></span></div></div>
      <div class="section-body">
        <% cartItems.forEach(item => { %>
          <div class="summary-item">
            <div><%= item.name %> × <%= item.quantity %></div>
            <div>¥<%= (item.price * item.quantity).toFixed(2) %></div>
          </div>
        <% }) %>
        <div class="total-line">
          <span>合计</span>
          <span>¥<%= totalAmount %></span>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header"><div class="section-title">选择支付方式</div></div>
      <div class="section-body">
        <div class="pay-methods" id="payMethods">
          <div class="pay-option" data-method="credit-card">
            <input type="radio" name="payMethod" value="credit-card">信用卡
          </div>
          <div class="pay-option" data-method="wechat">
            <input type="radio" name="payMethod" value="wechat">微信支付
          </div>
          <div class="pay-option" data-method="alipay">
            <input type="radio" name="payMethod" value="alipay">支付宝
          </div>
        </div>

        <div class="pay-content">
          <div id="ccForm" class="cc-form">
            <div class="full">
              <label>持卡人姓名</label>
              <input type="text" id="cc-name" placeholder="姓名">
            </div>
            <div class="full">
              <label>卡号</label>
              <input type="text" id="cc-number" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
            </div>
            <div>
              <label>有效期(月/年)</label>
              <input type="text" id="cc-exp" placeholder="MM/YY" maxlength="5">
            </div>
            <div>
              <label>安全码(CVV)</label>
              <input type="text" id="cc-cvv" placeholder="CVV" maxlength="4">
            </div>
          </div>

          <div id="wechatBox" class="qr-box">
            <img src="/image/pay/wechat_qr.png" alt="微信支付二维码">
          </div>

          <div id="alipayBox" class="qr-box">
            <img src="/image/pay/alipay_qr.png" alt="支付宝二维码">
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="window.location.href='/cart'">返回购物车</button>
          <button class="btn btn-primary" id="confirmPay">确认支付</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const methodContainer = document.getElementById('payMethods');
      const ccForm = document.getElementById('ccForm');
      const wechatBox = document.getElementById('wechatBox');
      const alipayBox = document.getElementById('alipayBox');
      const confirmBtn = document.getElementById('confirmPay');
      const summaryToggle = document.getElementById('summaryToggle');
      const summarySection = document.getElementById('summarySection');

      function setActive(method){
        document.querySelectorAll('.pay-option').forEach(opt => {
          opt.classList.toggle('active', opt.dataset.method === method);
          const radio = opt.querySelector('input[type=radio]');
          radio.checked = opt.dataset.method === method;
        });
        ccForm.classList.toggle('active', method === 'credit-card');
        wechatBox.classList.toggle('active', method === 'wechat');
        alipayBox.classList.toggle('active', method === 'alipay');
      }

      methodContainer.addEventListener('click', e => {
        const opt = e.target.closest('.pay-option');
        if (!opt) return;
        setActive(opt.dataset.method);
      });

      setActive('wechat');

      summaryToggle.addEventListener('click', () => {
        const collapsed = summarySection.classList.toggle('collapsed');
        summaryToggle.querySelector('span:nth-child(2)').textContent = collapsed ? '展开' : '收起';
      });

      const CART_ITEMS = <%- JSON.stringify(cartItems.map(function(ci){ return { productId: ci.product_id, quantity: ci.quantity, price: ci.price }; })) %>;
      const TOTAL_AMOUNT = <%= totalAmount %>;
      confirmBtn.addEventListener('click', async () => {
        try {
          const payload = { items: CART_ITEMS, totalAmount: TOTAL_AMOUNT, shippingAddress: {} };
          const r = await fetch('/order/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const d = await r.json();
          if (d && d.success && d.data && d.data.orderId) {
            window.location.href = '/order/' + d.data.orderId + '/view';
          } else {
            window.location.href = '/order/simple-success';
          }
        } catch (e) {
          window.location.href = '/order/simple-success';
        }
      });
    })();
  </script>
</body>
</html>
