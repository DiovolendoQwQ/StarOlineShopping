    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentDays = Number(document.body?.dataset?.days || 30);
        let charts = {};
        let sortBy = 'views';
        let adminWs = null;
        let overviewInterval = null;

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function () {
            initializeNavigation();
            initializeCharts();
            initializeEventListeners();
            loadData();
            connectAdminWs();
            // --- Êñ∞Â¢ûÔºöËá™Âä®Âà∑Êñ∞ÈÄªËæë (ÊØè 2 ÁßíÂà∑Êñ∞‰∏ÄÊ¨°) --- 
            console.log('ÂêØÂä®Ëá™Âä®Âà∑Êñ∞Êú∫Âà∂...'); 
            setInterval(async () => { 
                try { 
                    // 1. Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂÆûÊó∂Êï∞ÊçÆ 
                    const res = await fetch(`/analytics/api/realtime-overview?days=${currentDays}`); 
                    if (res.ok) { 
                        const json = await res.json(); 
                        // 2. Êõ¥Êñ∞ÁïåÈù¢‰∏äÁöÑÊï∞Â≠ó 
                        if (json.data) { 
                            updateRealtimeOverview(json.data); 
                            // Âú®ÊéßÂà∂Âè∞ÊâìÂç∞‰∏Ä‰∏ãÔºåËÆ©‰Ω†Áü•ÈÅìÂÆÉÂú®Â∑•‰Ωú 
                            console.log('üîÑ Êï∞ÊçÆÂ∑≤Ëá™Âä®Âà∑Êñ∞:', new Date().toLocaleTimeString()); 
                            
                            // 3. ÂèØÈÄâÔºöÁªôÊÄªÊî∂ÂÖ•Âä†‰∏™Èó™ÁÉÅÁâπÊïàÔºåÊèêÁ§∫Áî®Êà∑Êï∞ÊçÆÂèò‰∫Ü 
                            const revenueEl = document.getElementById('total-revenue'); 
                            if (revenueEl) { 
                                revenueEl.style.color = '#4ade80'; // ÂèòÁªø‰∏Ä‰∏ã 
                                setTimeout(() => { revenueEl.style.color = ''; }, 500); 
                            } 
                        } 
                    } 
                } catch (err) { 
                    console.error('Ëá™Âä®Âà∑Êñ∞Â§±Ë¥•:', err); 
                } 
            }, 2000); // 2000ÊØ´Áßí = 2Áßí 
            // -------------------------------------------
            initializeCustomerService();
            if (document.getElementById('admin-cs-session')) { document.getElementById('admin-cs-session').textContent = window.CustomerService.sessionId(); }
        });

        // ÂàùÂßãÂåñÂØºËà™
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.section');
            const dayButtons = document.querySelectorAll('[data-days]');
            const mainContainer = document.querySelector('.col-md-10 > .container-fluid.py-4');
            const dayGroup = document.getElementById('day-range-group');
            const hideSections = new Set(['server-monitor','error-logs','customer-service']);

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetSection = this.getAttribute('data-section');

                    // Êõ¥Êñ∞ÂØºËà™Áä∂ÊÄÅ
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    // ÊòæÁ§∫ÂØπÂ∫îÈÉ®ÂàÜ
                    sections.forEach(section => {
                        section.style.display = section.id === targetSection ? 'block' : 'none';
                    });
                    if (mainContainer) mainContainer.style.display = 'block';
                    if (dayGroup) dayGroup.style.display = hideSections.has(targetSection) ? 'none' : 'inline-flex';
                });
            });

            dayButtons.forEach(button => {
                button.addEventListener('click', function () {
                    dayButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDays = parseInt(this.getAttribute('data-days'));
                    loadData();
                });
            });

            const active = document.querySelector('.nav-link.active');
            if (active) {
                const targetSection = active.getAttribute('data-section');
                sections.forEach(section => { section.style.display = section.id === targetSection ? 'block' : 'none'; });
                if (mainContainer) mainContainer.style.display = 'block';
                if (dayGroup) dayGroup.style.display = hideSections.has(targetSection) ? 'none' : 'inline-flex';
            }
        }

        function initializeCustomerService() {
            const statusEl = document.getElementById('admin-cs-status');
            const chatEl = document.getElementById('admin-cs-chat');
            const inputEl = document.getElementById('admin-cs-input');
            const sendBtn = document.getElementById('admin-cs-send');
            const toastEl = document.getElementById('admin-cs-toast');
            if (!chatEl || !inputEl || !sendBtn) return;
            function fmtTime() { return new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' }); }
            function showToast(text) { toastEl.textContent = text; toastEl.classList.add('show'); setTimeout(() => { toastEl.classList.remove('show'); }, 2000); }
            function addMsg(text, who) {
                const row = document.createElement('div');
                row.className = 'cs-msg-row ' + (who === 'me' ? 'me' : 'srv');
                const avatar = document.createElement('div');
                avatar.className = 'cs-avatar ' + (who === 'me' ? 'me' : 'srv');
                avatar.textContent = who === 'me' ? 'Êàë' : 'ÂÆ¢';
                const bubble = document.createElement('div');
                bubble.className = 'cs-bubble ' + (who === 'me' ? 'me' : 'srv');
                bubble.innerHTML = '<div>' + text + '</div><div class="cs-time">' + fmtTime() + '</div>';
                if (who === 'me') { row.appendChild(bubble); row.appendChild(avatar); } else { row.appendChild(avatar); row.appendChild(bubble); }
                chatEl.appendChild(row);
                chatEl.scrollTop = chatEl.scrollHeight;
            }
            function doSend() {
                const text = (inputEl.value || '').trim();
                if (!text) return;
                addMsg(text, 'me');
                inputEl.value = '';
                window.CustomerService.sendQuestion(text);
            }
            document.addEventListener('cs:status', function (ev) {
                const d = ev.detail || {};
                if (statusEl) { statusEl.classList.toggle('offline', !d.connected); statusEl.innerHTML = (d.connected ? '<span class="dot"></span>Â∑≤ËøûÊé•' : '<span class="dot"></span>Êú™ËøûÊé•ÔºåËá™Âä®ÈáçËØï‰∏≠...'); }
                if (sendBtn) sendBtn.disabled = false;
            });
            document.addEventListener('cs:message', function (ev) {
                const msg = ev.detail || {};
                if (msg.type === 'reply') { addMsg(msg.message || 'ÂÆ¢ÊúçÂõûÂ§ç', 'srv'); }
                if (msg.type === 'ack') { showToast('Â∑≤Êî∂Âà∞ÔºåÊàë‰ª¨‰ºöÂ∞ΩÂø´ÂõûÂ§ç'); }
            });
            sendBtn.addEventListener('click', doSend);
            inputEl.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); doSend(); } });
            try { window.CustomerService.connect(); } catch (_) { }
        }

        function connectAdminWs() {
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            adminWs = new WebSocket(`${proto}://${location.host}/admin/ws`);
            adminWs.onmessage = function (ev) {
                let msg; try { msg = JSON.parse(ev.data); } catch (_) { msg = { type: 'raw', data: ev.data }; }
                console.log('Êî∂Âà∞WSÊ∂àÊÅØ:', msg);
                if (msg.type === 'metrics') updateMetrics(msg.metrics);
                if (msg.type === 'clients') updateClients(msg.clients);
                if (msg.type === 'log') { appendLog(msg.log); if (msg.log && msg.log.level === 'error') appendErrorLog(msg.log.message || 'ERROR'); }
                if (msg.type === 'server_log') appendServerLog(msg.data || msg);
                if (msg.type === 'error_log') appendErrorLog(msg.data);
                if (msg.type === 'app_error') appendErrorLog(msg.data);
                if (msg.type === 'log_init' && Array.isArray(msg.logs)) { msg.logs.forEach(appendLog); }
            };
        }

        function gb(n) { return (n / 1024 / 1024 / 1024).toFixed(2); }
        function currentNumber(el) { const m = String(el?.textContent || '').match(/[\d.]+/); return m ? parseFloat(m[0]) : 0; }
        function setDisplayText(el, value) { const id = el.id || ''; if (id === 'total-revenue') { el.textContent = '¬•' + Number(value).toFixed(2); } else if (id === 'avg-order-value') { el.textContent = Number(value).toFixed(2); } else { el.textContent = Math.round(Number(value)); } }
        function animateValue(id, start, end, duration) { const el = document.getElementById(id); if (!el) return; if (start === undefined || start === null) start = currentNumber(el); const s = Number(start) || 0; const e = Number(end) || 0; if (s === e) { setDisplayText(el, e); return; } const t0 = performance.now(); const run = (now) => { const p = Math.min((now - t0) / duration, 1); const val = s + (e - s) * p; setDisplayText(el, val); if (p < 1) requestAnimationFrame(run); }; requestAnimationFrame(run); }
        async function refreshRealtimeData() { try { const resp = await fetch(`/analytics/api/realtime-overview?days=${currentDays}`); if (!resp.ok) throw new Error(`HTTP ${resp.status}`); const data = await resp.json(); updateRealtimeOverview(data.data); } catch (e) { console.error('ÂÆûÊó∂Ê¶ÇËßàÂà∑Êñ∞Â§±Ë¥•', e && e.message ? e.message : e); if (overviewInterval) { clearInterval(overviewInterval); overviewInterval = null; } } }
        function startAutoRefresh() { try { if (overviewInterval) clearInterval(overviewInterval); refreshRealtimeData(); overviewInterval = setInterval(async () => { try { const res = await fetch(`/analytics/api/realtime-overview?days=${currentDays}`); if (res.ok) { const json = await res.json(); updateRealtimeOverview(json.data); } } catch (e) { console.error('Ëá™Âä®Âà∑Êñ∞Â§±Ë¥•:', e); } }, 3000); window.addEventListener('beforeunload', function () { if (overviewInterval) { try { clearInterval(overviewInterval); } catch (_) { } overviewInterval = null; } }); } catch (_) { }
        }
        function updateMetrics(m) {
            const cpuEl = document.getElementById('cpu-usage');
            const freeEl = document.getElementById('mem-free');
            const totalEl = document.getElementById('mem-total');
            if (cpuEl) cpuEl.textContent = `${m.cpu}%`;
            if (freeEl) freeEl.textContent = gb(m.memory.free);
            if (totalEl) totalEl.textContent = gb(m.memory.total);
        }
        function updateClients(list) {
            const el = document.getElementById('client-list');
            if (!el) return;
            el.innerHTML = '';
            const count = Array.isArray(list) ? list.length : 0;
            const t = document.createElement('div');
            t.textContent = `Âú®Á∫ø‰ºöËØù: ${count}`;
            el.appendChild(t);
            if (count > 0) {
                const ul = document.createElement('ul');
                list.forEach(c => { const li = document.createElement('li'); li.textContent = c.sessionId; ul.appendChild(li); });
                el.appendChild(ul);
            }
        }
        function appendLog(log) {
            const term = document.getElementById('terminal-window');
            if (!term) return;
            const rawMsg = (log.message || '');
            const rawPath = (log.path || log.url || log.uri || log.route || '');
            if ((rawMsg && rawMsg.includes('@vite')) || (rawPath && rawPath.includes('@vite'))) return;
            const cursorId = 'terminal-cursor';
            let cursor = document.getElementById(cursorId);
            if (cursor && cursor.parentElement) { try { cursor.parentElement.removeChild(cursor); } catch (_) {} }
            const line = document.createElement('div');
            line.className = 'terminal-line';
            const method = String((log.method || log.httpMethod || log.m || '')).toUpperCase();
            const path = rawPath;
            const statusNum = parseInt((log.status || log.statusCode || ''), 10) || (function(){ const m=(log.message||'').match(/\b(\d{3})\b/); return m?parseInt(m[1],10):0; })();
            const msValRaw = (log.ms ?? log.responseTime ?? log.duration ?? (function(){ const m=(log.message||'').match(/([\d.]+)\s*ms/); return m?m[1]:''; })());
            const msVal = msValRaw ? Number(msValRaw) : '';
            const sizeVal = (log.length ?? log.contentLength ?? log.size ?? (function(){ const m=(log.message||'').match(/-\s*(\d+)/); return m?m[1]:''; })());
            const sMethod = document.createElement('span'); sMethod.className = 't-method'; sMethod.textContent = method?`[${method}]`:'';
            const sPath = document.createElement('span'); sPath.className = 't-path'; sPath.textContent = path?` ${path}`:'';
            const sStatus = document.createElement('span'); sStatus.className = 't-status ' + (statusNum>=500?'err':statusNum>=400?'warn':statusNum>=300?'redir':'ok'); sStatus.textContent = statusNum?` ${statusNum}`:'';
            const sTime = document.createElement('span'); sTime.className = 't-time'; sTime.textContent = msVal!==''?` ${msVal} ms`:'';
            const sSize = document.createElement('span'); sSize.className = 't-size'; sSize.textContent = sizeVal?` - ${sizeVal}`:'';
            if (!method && !path && !statusNum && msVal==='') { line.textContent = (log.message || JSON.stringify(log)); }
            else { line.appendChild(sMethod); line.appendChild(sPath); line.appendChild(sStatus); line.appendChild(sTime); line.appendChild(sSize); }
            term.appendChild(line);
            cursor = document.createElement('span'); cursor.id = cursorId; cursor.className = 'terminal-cursor';
            term.appendChild(cursor);
            term.scrollTop = term.scrollHeight;
        }

        function appendServerLog(data) {
            const term = document.getElementById('terminal-window');
            if (!term) return;
            const rawPath = data.url || data.path || '';
            if (rawPath.includes('@vite')) return;
            const cursorId = 'terminal-cursor';
            let cursor = document.getElementById(cursorId);
            if (cursor && cursor.parentElement) { try { cursor.parentElement.removeChild(cursor); } catch (_) {} }
            const line = document.createElement('div');
            line.className = 'log-line';
            const method = String((data.method||'')).toUpperCase();
            const path = rawPath;
            const statusNum = Number(data.status||0);
            const msVal = Number((data.time!==undefined?data.time:''));
            const sMethod = document.createElement('span'); sMethod.className = 't-method'; sMethod.textContent = method?`[${method}]`:'';
            const sPath = document.createElement('span'); sPath.className = 't-path'; sPath.textContent = path?` ${path}`:'';
            const sStatus = document.createElement('span'); sStatus.className = 't-status ' + (statusNum>=500?'err':statusNum>=400?'warn':statusNum>=300?'redir':'ok'); sStatus.textContent = statusNum?` ${statusNum}`:'';
            const sTime = document.createElement('span'); sTime.className = 't-time'; sTime.textContent = (msVal||msVal===0)?` ${msVal} ms`:'';
            line.appendChild(sMethod); line.appendChild(sPath); line.appendChild(sStatus); line.appendChild(sTime);
            term.appendChild(line);
            cursor = document.createElement('span'); cursor.id = cursorId; cursor.className = 'terminal-cursor';
            term.appendChild(cursor);
            term.scrollTop = term.scrollHeight;
            if (statusNum >= 400) {
                const msg = `[${method}] ${path} ${statusNum} ${msVal} ms`;
                appendErrorLog(msg);
            }
        }

        function appendErrorLog(message) {
            const list = document.getElementById('log-list');
            if (!list) return console.error('Êâæ‰∏çÂà∞ log-list ÂÆπÂô®');
            const item = document.createElement('div');
            item.className = 'alert alert-danger d-flex align-items-center mb-2';
            item.style.padding = '8px 12px';
            item.innerHTML = `
                <i class="fas fa-times-circle me-2"></i>
                <div>
                    <small class="text-muted" style="display:block; font-size:0.8em">${new Date().toLocaleTimeString()}</small>
                    <span style="font-family:monospace; word-break:break-all;">${message}</span>
                </div>
            `;
            list.prepend(item);
        }

        // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function initializeEventListeners() {
            // ‰∫ßÂìÅÊéíÂ∫èÊåâÈíÆ
            document.getElementById('sort-by-views')?.addEventListener('click', () => {
                sortBy = 'views';
                loadProductData();
            });
            document.getElementById('sort-by-sales')?.addEventListener('click', () => {
                sortBy = 'sales';
                loadProductData();
            });
            document.getElementById('sort-by-revenue')?.addEventListener('click', () => {
                sortBy = 'revenue';
                loadProductData();
            });
        }

        // ÂàùÂßãÂåñÂõæË°®
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js Êú™Âä†ËΩΩÔºåË∑≥ËøáÂõæË°®ÂàùÂßãÂåñ');
                return;
            }
            // Ë°å‰∏∫Á±ªÂûãÂàÜÂ∏ÉÈ•ºÂõæ
            if (document.getElementById('behaviorChart')) {
                const behaviorCtx = document.getElementById('behaviorChart').getContext('2d');
                charts.behavior = new Chart(behaviorCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // ËΩ¨ÂåñÊºèÊñóÂõæ
            if (document.getElementById('conversionChart')) {
                const funnelCtx = document.getElementById('conversionChart').getContext('2d');
                charts.funnel = new Chart(funnelCtx, {
                    type: 'bar',
                    data: {
                        labels: ['ÊµèËßà', 'Âä†Ë¥≠Áâ©ËΩ¶', 'Ë¥≠‰π∞'],
                        datasets: [{
                            label: 'Áî®Êà∑Êï∞Èáè',
                            data: [],
                            backgroundColor: ['#36A2EB', '#FFCE56', '#4BC0C0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Êî∂ÂÖ•Ë∂ãÂäøÂõæ
            if (document.getElementById('revenueChart')) {
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                charts.revenue = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Êî∂ÂÖ•',
                            data: [],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Áî®Êà∑Ê¥ªË∑ÉÂ∫¶Êó∂Èó¥ÂàÜÂ∏ÉÂõæ
            if (document.getElementById('hourlyActivityChart')) {
                const hourlyCtx = document.getElementById('hourlyActivityChart').getContext('2d');
                charts.hourlyActivity = new Chart(hourlyCtx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'Ê¥ªË∑ÉÁî®Êà∑Êï∞',
                            data: [],
                            backgroundColor: '#17a2b8'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Áî®Êà∑ÁªÜÂàÜÂõæ
            if (document.getElementById('userSegmentChart')) {
                const segmentCtx = document.getElementById('userSegmentChart').getContext('2d');
                charts.userSegment = new Chart(segmentCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Êñ∞Áî®Êà∑', 'Ê¥ªË∑ÉÁî®Êà∑', 'Ê≤âÁù°Áî®Êà∑', 'ÊµÅÂ§±Áî®Êà∑'],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // ‰∫ßÂìÅÁ±ªÂà´ÈîÄÂîÆÂàÜÂ∏ÉÂõæ
            if (document.getElementById('categoryChart')) {
                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                charts.category = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // ‰∫ßÂìÅËØÑÂàÜÂàÜÂ∏ÉÂõæ
            if (document.getElementById('ratingChart')) {
                const ratingCtx = document.getElementById('ratingChart').getContext('2d');
                charts.rating = new Chart(ratingCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1Êòü', '2Êòü', '3Êòü', '4Êòü', '5Êòü'],
                        datasets: [{
                            label: '‰∫ßÂìÅÊï∞Èáè',
                            data: [],
                            backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // ‰∫ßÂìÅÈîÄÂîÆË∂ãÂäøÂõæ
            if (document.getElementById('productTrendChart')) {
                const productTrendCtx = document.getElementById('productTrendChart').getContext('2d');
                charts.productTrend = new Chart(productTrendCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Êó•Êúü'
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ÈîÄÂîÆÈáè'
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }

            // Ë∂ãÂäøÂõæ
            if (document.getElementById('trendChart')) {
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                charts.trend = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: true
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Êó•Êúü',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    lineWidth: 1
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    maxRotation: 45
                                }
                            },
                            y: {
                                display: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Êï∞Èáè',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    lineWidth: 1
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        },
                        elements: {
                            line: {
                                tension: 0.4
                            },
                            point: {
                                radius: 4,
                                hoverRadius: 6,
                                borderWidth: 2
                            }
                        }
                    }
                });
            }
        }

        // Âä†ËΩΩÊï∞ÊçÆ
        async function loadData() {
            console.log('ÂºÄÂßãÂä†ËΩΩÊï∞ÊçÆÔºåÂ§©Êï∞:', currentDays);

            try {
                // Âä†ËΩΩÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆ
                console.log('Ê≠£Âú®Âä†ËΩΩÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆ...');
                const realtimeResponse = await fetch(`/analytics/api/realtime-overview?days=${currentDays}`);
                if (!realtimeResponse.ok) {
                    throw new Error(`ÂÆûÊó∂Ê¶ÇËßàAPIËØ∑Ê±ÇÂ§±Ë¥•: ${realtimeResponse.status} ${realtimeResponse.statusText}`);
                }
                const realtimeData = await realtimeResponse.json();
                console.log('ÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆ:', realtimeData);
                updateRealtimeOverview(realtimeData.data);
                console.log('‚úÖ ÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');

                // Âä†ËΩΩÊ¶ÇËßàÊï∞ÊçÆ
                console.log('Ê≠£Âú®Âä†ËΩΩÊ¶ÇËßàÊï∞ÊçÆ...');
                const overviewResponse = await fetch(`/analytics/api/overview?days=${currentDays}`);
                if (!overviewResponse.ok) {
                    throw new Error(`Ê¶ÇËßàAPIËØ∑Ê±ÇÂ§±Ë¥•: ${overviewResponse.status} ${overviewResponse.statusText}`);
                }
                const overviewData = await overviewResponse.json();
                console.log('Ê¶ÇËßàÊï∞ÊçÆ:', overviewData);
                updateOverview(overviewData.data);
                console.log('‚úÖ Ê¶ÇËßàÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');

                // Âä†ËΩΩÈ´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ
                console.log('Ê≠£Âú®Âä†ËΩΩÈ´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ...');
                const advancedBehaviorResponse = await fetch(`/analytics/api/advanced-user-behavior?days=${currentDays}`);
                if (!advancedBehaviorResponse.ok) {
                    throw new Error(`È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫APIËØ∑Ê±ÇÂ§±Ë¥•: ${advancedBehaviorResponse.status} ${advancedBehaviorResponse.statusText}`);
                }
                const advancedBehaviorData = await advancedBehaviorResponse.json();
                console.log('È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ:', advancedBehaviorData);
                updateAdvancedBehaviorCharts(advancedBehaviorData.data);
                console.log('‚úÖ È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê');

                // Âä†ËΩΩÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ
                console.log('Ê≠£Âú®Âä†ËΩΩÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ...');
                const behaviorResponse = await fetch(`/analytics/api/user-behavior?days=${currentDays}`);
                if (!behaviorResponse.ok) {
                    throw new Error(`Áî®Êà∑Ë°å‰∏∫APIËØ∑Ê±ÇÂ§±Ë¥•: ${behaviorResponse.status} ${behaviorResponse.statusText}`);
                }
                const behaviorData = await behaviorResponse.json();
                console.log('Áî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ:', behaviorData);
                updateBehaviorCharts(behaviorData.data);
                console.log('‚úÖ Áî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê');

                // Âä†ËΩΩ‰∫ßÂìÅÊÄßËÉΩÊï∞ÊçÆ
                console.log('Ê≠£Âú®Âä†ËΩΩ‰∫ßÂìÅÊÄßËÉΩÊï∞ÊçÆ...');
                await loadProductData();
                console.log('‚úÖ ‰∫ßÂìÅÊÄßËÉΩÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');

                // Âä†ËΩΩË∂ãÂäøÊï∞ÊçÆ
                console.log('Ê≠£Âú®Âä†ËΩΩË∂ãÂäøÊï∞ÊçÆ...');
                const trendResponse = await fetch(`/analytics/api/trends?days=${currentDays}`);
                if (!trendResponse.ok) {
                    throw new Error(`Ë∂ãÂäøAPIËØ∑Ê±ÇÂ§±Ë¥•: ${trendResponse.status} ${trendResponse.statusText}`);
                }
                const trendData = await trendResponse.json();
                console.log('Ë∂ãÂäøÊï∞ÊçÆ:', trendData);
                updateTrendChart(trendData.data);
                console.log('‚úÖ Ë∂ãÂäøÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');

                console.log('üéâ ÊâÄÊúâÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');

            } catch (error) {
                console.error('‚ùå Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
                // ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
                showErrorMessage('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âä†ËΩΩ‰∫ßÂìÅÊï∞ÊçÆ
        async function loadProductData() {
            try {
                console.log('Ê≠£Âú®Âä†ËΩΩ‰∫ßÂìÅÊÄßËÉΩÊï∞ÊçÆ...');
                const productResponse = await fetch(`/analytics/api/product-performance?days=${currentDays}&sortBy=${sortBy}`);
                if (!productResponse.ok) {
                    throw new Error(`‰∫ßÂìÅÊÄßËÉΩAPIËØ∑Ê±ÇÂ§±Ë¥•: ${productResponse.status} ${productResponse.statusText}`);
                }
                const productData = await productResponse.json();
                console.log('‰∫ßÂìÅÊÄßËÉΩÊï∞ÊçÆ:', productData);

                if (!productData.data || !Array.isArray(productData.data)) {
                    throw new Error('‰∫ßÂìÅÊÄßËÉΩÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                }

                updateProductTable(productData.data);
                updateProductCharts(productData.data);
                return true;
            } catch (error) {
                console.error('‚ùå Âä†ËΩΩ‰∫ßÂìÅÊï∞ÊçÆÂ§±Ë¥•:', error);
                showErrorMessage('‰∫ßÂìÅÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ' + error.message);
                return false;
            }
        }

        // Êõ¥Êñ∞ÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆ
        function updateRealtimeOverview(data) {
            try {
                console.log('Ê≠£Âú®Êõ¥Êñ∞ÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆ:', data);
                if (data) {
                    // ‰ΩøÁî®Ê≠£Á°ÆÁöÑÊï∞ÊçÆÁªìÊûÑÂ≠óÊÆµ
                    const totalUsersEl = document.getElementById('total-users');
                    const dailyActiveUsersEl = document.getElementById('daily-active-users');
                    const totalOrdersEl = document.getElementById('total-orders');
                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const totalViewsEl = document.getElementById('total-views');

                    if (totalUsersEl) animateValue('total-users', currentNumber(totalUsersEl), Number(data.users?.total || 0), 1000);
                    if (dailyActiveUsersEl) animateValue('daily-active-users', currentNumber(dailyActiveUsersEl), Number(data.users?.daily_active || 0), 1000);
                    if (totalOrdersEl) animateValue('total-orders', currentNumber(totalOrdersEl), Number(data.orders?.total || 0), 1000);
                    if (totalRevenueEl) animateValue('total-revenue', currentNumber(totalRevenueEl), Number(data.orders?.total_revenue || 0), 1000);
                    if (avgOrderValueEl) animateValue('avg-order-value', currentNumber(avgOrderValueEl), Number(data.orders?.avg_value || 0), 1000);
                    if (totalViewsEl) totalViewsEl.textContent = data.products?.total_views || 0;
                    const conversionEl = document.getElementById('conversion-rate');
                    if (conversionEl && data.conversion_rates) {
                        conversionEl.textContent = (data.conversion_rates.viewToPurchase || 0) + '%';
                    }

                    // Â¶ÇÊûúÊúâ‰ºöËØùÊåáÊ†áÊï∞ÊçÆ
                    if (data.session_metrics) {
                        const avgSessionDurationEl = document.getElementById('avg-session-duration');
                        const bounceRateEl = document.getElementById('bounce-rate');
                        if (avgSessionDurationEl) avgSessionDurationEl.textContent = (data.session_metrics?.avg_duration || 0).toFixed(1);
                        if (bounceRateEl) bounceRateEl.textContent = `${(data.session_metrics?.bounce_rate || 0).toFixed(1)}%`;
                    }

                    // Êõ¥Êñ∞Êî∂ÂÖ•Ë∂ãÂäøÂõæ
                    if (charts.revenue && data.revenue_trend && Array.isArray(data.revenue_trend)) {
                        try {
                            charts.revenue.data.labels = data.revenue_trend.map(item => item.date);
                            charts.revenue.data.datasets[0].data = data.revenue_trend.map(item => item.daily_revenue || item.revenue || item.value || 0);
                            charts.revenue.update();
                            console.log('‚úÖ Êî∂ÂÖ•Ë∂ãÂäøÂõæÊõ¥Êñ∞ÂÆåÊàêÔºåÊï∞ÊçÆÁÇπÊï∞:', data.revenue_trend.length);
                        } catch (revenueError) {
                            console.error('‚ùå Êõ¥Êñ∞Êî∂ÂÖ•Ë∂ãÂäøÂõæÂ§±Ë¥•:', revenueError);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Êî∂ÂÖ•Ë∂ãÂäøÂõæÊï∞ÊçÆÁº∫Â§±ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ:', data.revenue_trend);
                    }
                    console.log('‚úÖ ÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆÊõ¥Êñ∞ÂÆåÊàê');
                } else {
                    console.warn('‚ö†Ô∏è ÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆ‰∏∫Á©∫');
                }
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞ÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆÂ§±Ë¥•:', error);
                showErrorMessage('ÂÆûÊó∂Ê¶ÇËßàÊï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞Ê¶ÇËßàÊï∞ÊçÆ
        function updateOverview(data) {
            if (data && data.users) {
                // Ëøô‰∫õÊï∞ÊçÆÂèØËÉΩÂ∑≤ÁªèÂú®ÂÆûÊó∂Ê¶ÇËßà‰∏≠Êõ¥Êñ∞‰∫Ü
            }
        }

        // Êõ¥Êñ∞È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ
        function updateAdvancedBehaviorCharts(data) {
            try {
                console.log('Ê≠£Âú®Êõ¥Êñ∞È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ:', data);
                if (data) {
                    // Êõ¥Êñ∞‰ºöËØùÊåáÊ†á
                    if (data.session_metrics) {
                        const avgSessionDurationEl = document.getElementById('avg-session-duration');
                        const bounceRateEl = document.getElementById('bounce-rate');
                        const avgActionsPerSessionEl = document.getElementById('avg-actions-per-session');

                        if (avgSessionDurationEl) avgSessionDurationEl.textContent = (data.session_metrics.avg_duration || 0) + ' ÂàÜÈíü';
                        if (bounceRateEl) bounceRateEl.textContent = `${(data.session_metrics.bounce_rate || 0)}%`;
                        if (avgActionsPerSessionEl) avgActionsPerSessionEl.textContent = (data.session_metrics.avg_actions_per_session || 0).toFixed(1);
                        console.log('‚úÖ ‰ºöËØùÊåáÊ†áÊõ¥Êñ∞ÂÆåÊàê');
                    } else {
                        console.warn('‚ö†Ô∏è ‰ºöËØùÊåáÊ†áÊï∞ÊçÆÁº∫Â§±');
                    }

                    // Êõ¥Êñ∞Áî®Êà∑Ê¥ªË∑ÉÂ∫¶Êó∂Èó¥ÂàÜÂ∏ÉÂõæ
                    if (charts.hourlyActivity && data.hourly_activity) {
                        try {
                            const hourlyData = new Array(24).fill(0);
                            data.hourly_activity.forEach(item => {
                                const hour = parseInt(item.hour);
                                if (!isNaN(hour) && hour >= 0 && hour < 24) {
                                    hourlyData[hour] = item.actions || 0;
                                }
                            });
                            charts.hourlyActivity.data.datasets[0].data = hourlyData;
                            charts.hourlyActivity.update();
                            console.log('‚úÖ Áî®Êà∑Ê¥ªË∑ÉÂ∫¶Êó∂Èó¥ÂàÜÂ∏ÉÂõæÊõ¥Êñ∞ÂÆåÊàê');
                        } catch (chartError) {
                            console.error('‚ùå Êõ¥Êñ∞Áî®Êà∑Ê¥ªË∑ÉÂ∫¶Êó∂Èó¥ÂàÜÂ∏ÉÂõæÂ§±Ë¥•:', chartError);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Áî®Êà∑Ê¥ªË∑ÉÂ∫¶Êó∂Èó¥ÂàÜÂ∏ÉÂõæÊï∞ÊçÆÊàñÂõæË°®ÂØπË±°Áº∫Â§±');
                    }

                    // Êõ¥Êñ∞ËÆæÂ§áÂàÜÂ∏ÉÂõæ
                    if (charts.userSegment && data.device_distribution) {
                        try {
                            const deviceLabels = data.device_distribution.map(item => item.device_type || 'Êú™Áü•ËÆæÂ§á');
                            const deviceData = data.device_distribution.map(item => item.users || 0);
                            charts.userSegment.data.labels = deviceLabels;
                            charts.userSegment.data.datasets[0].data = deviceData;
                            charts.userSegment.update();
                            console.log('‚úÖ ËÆæÂ§áÂàÜÂ∏ÉÂõæÊõ¥Êñ∞ÂÆåÊàê');
                        } catch (chartError) {
                            console.error('‚ùå Êõ¥Êñ∞ËÆæÂ§áÂàÜÂ∏ÉÂõæÂ§±Ë¥•:', chartError);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è ËÆæÂ§áÂàÜÂ∏ÉÂõæÊï∞ÊçÆÊàñÂõæË°®ÂØπË±°Áº∫Â§±');
                    }

                    // Êõ¥Êñ∞Áî®Êà∑Ë∑ØÂæÑÂàóË°®
                    if (data.user_paths) {
                        try {
                            updateUserPaths(data.user_paths);
                            console.log('‚úÖ Áî®Êà∑Ë∑ØÂæÑÂàóË°®Êõ¥Êñ∞ÂÆåÊàê');
                        } catch (pathError) {
                            console.error('‚ùå Êõ¥Êñ∞Áî®Êà∑Ë∑ØÂæÑÂàóË°®Â§±Ë¥•:', pathError);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Áî®Êà∑Ë∑ØÂæÑÊï∞ÊçÆÁº∫Â§±');
                    }

                    console.log('‚úÖ È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÊõ¥Êñ∞ÂÆåÊàê');
                } else {
                    console.warn('‚ö†Ô∏è È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆ‰∏∫Á©∫');
                }
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÂ§±Ë¥•:', error);
                showErrorMessage('È´òÁ∫ßÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞Áî®Êà∑Ë∑ØÂæÑ
        function updateUserPaths(paths) {
            const pathsList = document.getElementById('user-paths-list');
            if (pathsList) {
                pathsList.innerHTML = '';

                // Â§ÑÁêÜÁî®Êà∑Ë∑ØÂæÑÊï∞ÊçÆÔºåÊåâÁî®Êà∑ÂàÜÁªÑÊòæÁ§∫ÊúÄËøëÁöÑË°å‰∏∫Â∫èÂàó
                const userGroups = {};
                paths.forEach(path => {
                    if (!userGroups[path.user_id]) {
                        userGroups[path.user_id] = [];
                    }
                    userGroups[path.user_id].push(path);
                });

                // ÊòæÁ§∫Ââç5‰∏™Áî®Êà∑ÁöÑË°å‰∏∫Ë∑ØÂæÑ
                Object.keys(userGroups).slice(0, 5).forEach((userId, index) => {
                    const userPaths = userGroups[userId].slice(0, 5); // ÊØè‰∏™Áî®Êà∑ÊòæÁ§∫ÊúÄÂ§ö5‰∏™Ë°å‰∏∫
                    const pathElement = document.createElement('div');
                    pathElement.className = 'mb-2 p-2 bg-dark rounded';

                    const pathSequence = userPaths.map(p => p.action_type).join(' ‚Üí ');
                    pathElement.innerHTML = `
                        <small class="text-muted">Áî®Êà∑ #${userId}</small>
                        <div class="text-light">${pathSequence}</div>
                        <small class="text-info">${userPaths.length} ‰∏™Ë°å‰∏∫</small>
                    `;
                    pathsList.appendChild(pathElement);
                });
            }
        }

        // Êõ¥Êñ∞Ë°å‰∏∫ÂõæË°®
        function updateBehaviorCharts(data) {
            try {
                console.log('Ê≠£Âú®Êõ¥Êñ∞Áî®Êà∑Ë°å‰∏∫ÂõæË°®ÂíåÊåáÊ†á...', data);

                // Êõ¥Êñ∞Áî®Êà∑Ë°å‰∏∫Ê¶ÇËßàÊåáÊ†á
                try {
                    const totalClicksEl = document.getElementById('total-clicks');
                    const cartAddsEl = document.getElementById('cart-additions');
                    const wishlistAddsEl = document.getElementById('wishlist-additions');
                    const sharesEl = document.getElementById('shares');

                    // ‰ªéactionStats‰∏≠ÊèêÂèñÂêÑÁßçË°å‰∏∫ÁöÑÁªüËÆ°Êï∞ÊçÆ
                    let totalClicks = 0;
                    let cartAdditions = 0;
                    let wishlistAdditions = 0;
                    let shares = 0;

                    if (data.actionStats && Array.isArray(data.actionStats)) {
                        data.actionStats.forEach(stat => {
                            const actionType = stat.action_type;
                            const count = stat.count || 0;

                            // ÁªüËÆ°ÁÇπÂáªÊï∞ÔºàÂåÖÊã¨ÊµèËßà„ÄÅ‰∫ßÂìÅÊü•ÁúãÁ≠âÔºâ
                            if (actionType === 'view' || actionType === 'product_view' || actionType === 'click') {
                                totalClicks += count;
                            }
                            // ÁªüËÆ°Âä†Ë¥≠Ê¨°Êï∞
                            else if (actionType === 'add_to_cart') {
                                cartAdditions += count;
                            }
                            // ÁªüËÆ°Êî∂ËóèÊ¨°Êï∞
                            else if (actionType === 'wishlist' || actionType === 'favorite' || actionType === 'add_to_wishlist') {
                                wishlistAdditions += count;
                            }
                            // ÁªüËÆ°ÂàÜ‰∫´Ê¨°Êï∞
                            else if (actionType === 'share') {
                                shares += count;
                            }
                        });
                    }

                    // Â¶ÇÊûúÊ≤°Êúâ‰ªéactionStatsËé∑ÂèñÂà∞Êï∞ÊçÆÔºåÂ∞ùËØï‰ªérawConversionDataËé∑Âèñ
                    if (totalClicks === 0 && data.rawConversionData) {
                        totalClicks = data.rawConversionData.views || 0;
                        cartAdditions = data.rawConversionData.cart_adds || 0;
                    }

                    // Êõ¥Êñ∞DOMÂÖÉÁ¥†
                    if (totalClicksEl) totalClicksEl.textContent = totalClicks;
                    if (cartAddsEl) cartAddsEl.textContent = cartAdditions;
                    if (wishlistAddsEl) wishlistAddsEl.textContent = wishlistAdditions;
                    if (sharesEl) sharesEl.textContent = shares;

                    console.log('‚úÖ Áî®Êà∑Ë°å‰∏∫Ê¶ÇËßàÊåáÊ†áÊõ¥Êñ∞ÂÆåÊàê:', {
                        totalClicks,
                        cartAdditions,
                        wishlistAdditions,
                        shares
                    });
                } catch (metricsError) {
                    console.error('‚ùå Êõ¥Êñ∞Áî®Êà∑Ë°å‰∏∫Ê¶ÇËßàÊåáÊ†áÂ§±Ë¥•:', metricsError);
                }

                // Êõ¥Êñ∞Ë°å‰∏∫ÂàÜÂ∏ÉÂõæË°®
                if (data.actionStats && charts.behavior) {
                    try {
                        charts.behavior.data.labels = data.actionStats.map(item => item.action_type);
                        charts.behavior.data.datasets[0].data = data.actionStats.map(item => item.count);
                        charts.behavior.update();
                        console.log('‚úÖ Ë°å‰∏∫ÂàÜÂ∏ÉÂõæË°®Êõ¥Êñ∞ÂÆåÊàê');
                    } catch (chartError) {
                        console.error('‚ùå Êõ¥Êñ∞Ë°å‰∏∫ÂàÜÂ∏ÉÂõæË°®Â§±Ë¥•:', chartError);
                    }
                }

                // Êõ¥Êñ∞ËΩ¨ÂåñÊºèÊñóÂõæË°®
                if (data.rawConversionData && charts.funnel) {
                    try {
                        charts.funnel.data.datasets[0].data = [
                            data.rawConversionData.views,
                            data.rawConversionData.cart_adds,
                            data.rawConversionData.purchases
                        ];
                        charts.funnel.update();
                        console.log('‚úÖ ËΩ¨ÂåñÊºèÊñóÂõæË°®Êõ¥Êñ∞ÂÆåÊàê');
                    } catch (funnelError) {
                        console.error('‚ùå Êõ¥Êñ∞ËΩ¨ÂåñÊºèÊñóÂõæË°®Â§±Ë¥•:', funnelError);
                    }
                }

                console.log('‚úÖ Áî®Êà∑Ë°å‰∏∫ÂõæË°®ÂíåÊåáÊ†áÊõ¥Êñ∞ÂÆåÊàê');
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞Áî®Êà∑Ë°å‰∏∫ÂõæË°®Â§±Ë¥•:', error);
                showErrorMessage('Áî®Êà∑Ë°å‰∏∫ÂõæË°®Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞‰∫ßÂìÅË°®Ê†º
        function updateProductTable(data) {
            try {
                console.log('Ê≠£Âú®Êõ¥Êñ∞‰∫ßÂìÅË°®Ê†ºÔºåÊï∞ÊçÆÈïøÂ∫¶:', data ? data.length : 0);
                const tbody = document.querySelector('#productTable tbody');
                if (!tbody) {
                    console.error('‚ùå Êâæ‰∏çÂà∞‰∫ßÂìÅË°®Ê†ºtbodyÂÖÉÁ¥†');
                    return;
                }

                tbody.innerHTML = '';

                if (!data || !Array.isArray(data)) {
                    console.warn('‚ö†Ô∏è ‰∫ßÂìÅÊï∞ÊçÆ‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                    const row = tbody.insertRow();
                    row.innerHTML = '<td colspan="10" class="text-center text-muted">ÊöÇÊó†‰∫ßÂìÅÊï∞ÊçÆ</td>';
                    return;
                }

                data.forEach((product, index) => {
                    try {
                        // ‰ªé‰∫ßÂìÅÂêçÁß∞Êé®Êñ≠Á±ªÂà´
                        let category = 'Êú™ÂàÜÁ±ª';
                        const name = product.name || '';
                        if (name.includes('ÊâãÊú∫')) category = 'ÊâãÊú∫';
                        else if (name.includes('ÁîµËÑë') || name.includes('Á¨îËÆ∞Êú¨')) category = 'ÁîµËÑë';
                        else if (name.includes('ËÄ≥Êú∫')) category = 'ËÄ≥Êú∫';
                        else if (name.includes('ÂÖÖÁîµÂô®')) category = 'ÂÖÖÁîµÂô®';
                        else if (name.includes('Èü≥Âìç')) category = 'Èü≥Âìç';
                        else if (name.includes('Âπ≥Êùø')) category = 'Âπ≥Êùø';
                        else if (name.includes('Êï∞ÊçÆÁ∫ø')) category = 'Êï∞ÊçÆÁ∫ø';
                        else if (name.includes('ÈîÆÁõò')) category = 'ÈîÆÁõò';
                        else if (name.includes('Èº†Ê†á')) category = 'Èº†Ê†á';
                        else if (name.includes('ÊòæÁ§∫Âô®')) category = 'ÊòæÁ§∫Âô®';

                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${product.name || 'Êú™Áü•‰∫ßÂìÅ'}</td>
                            <td>${product.category || category}</td>
                            <td>${product.views || 0}</td>
                            <td>${product.cart_adds || 0}</td>
                            <td>${product.purchases || 0}</td>
                            <td>${parseFloat(product.conversion_rate || 0).toFixed(2)}%</td>
                            <td>¬•${parseFloat(product.revenue || 0).toFixed(2)}</td>
                            <td>${parseFloat(product.avg_preference_score || 0).toFixed(1)}</td>
                            <td>${product.stock || 0}</td>
                        `;
                    } catch (rowError) {
                        console.error(`‚ùå ÂàõÂª∫‰∫ßÂìÅË°®Ê†ºË°åÂ§±Ë¥• (Á¥¢Âºï ${index}):`, rowError, product);
                    }
                });

                console.log(`‚úÖ ‰∫ßÂìÅË°®Ê†ºÊõ¥Êñ∞ÂÆåÊàêÔºåÂÖ± ${data.length} Ë°å`);
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞‰∫ßÂìÅË°®Ê†ºÂ§±Ë¥•:', error);
                showErrorMessage('‰∫ßÂìÅË°®Ê†ºÊõ¥Êñ∞Â§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞‰∫ßÂìÅÂõæË°®
        function updateProductCharts(data) {
            try {
                console.log('Ê≠£Âú®Êõ¥Êñ∞‰∫ßÂìÅÂõæË°®ÔºåÊï∞ÊçÆÈïøÂ∫¶:', data ? data.length : 0);

                if (!data || !Array.isArray(data)) {
                    console.warn('‚ö†Ô∏è ‰∫ßÂìÅÂõæË°®Êï∞ÊçÆ‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                    return;
                }

                // Êõ¥Êñ∞‰∫ßÂìÅÊ¶ÇËßàÊåáÊ†á
                try {
                    const totalProductsEl = document.getElementById('total-products');
                    const hotProductsEl = document.getElementById('hot-products');
                    const trendingProductsEl = document.getElementById('trending-products');
                    const lowStockProductsEl = document.getElementById('low-stock-products');

                    if (totalProductsEl) totalProductsEl.textContent = data.length || 0;
                    if (hotProductsEl) hotProductsEl.textContent = data.filter(p => (p.views || 0) > 100).length || 0;

                    // ‰ΩøÁî®composite_score‰Ωú‰∏∫Ë∂ãÂäøÊåáÊ†áÁöÑÊõø‰ª£
                    const trendingCount = data.filter(p => (p.composite_score || 0) > 50).length || 0;
                    if (trendingProductsEl) trendingProductsEl.textContent = trendingCount;

                    if (lowStockProductsEl) lowStockProductsEl.textContent = data.filter(p => (p.stock || 0) < 10).length || 0;

                    console.log('‚úÖ ‰∫ßÂìÅÊ¶ÇËßàÊåáÊ†áÊõ¥Êñ∞ÂÆåÊàê');
                } catch (metricsError) {
                    console.error('‚ùå Êõ¥Êñ∞‰∫ßÂìÅÊ¶ÇËßàÊåáÊ†áÂ§±Ë¥•:', metricsError);
                }

                // Êõ¥Êñ∞‰∫ßÂìÅÁ±ªÂà´ÂàÜÂ∏ÉÂõæ
                if (charts.category) {
                    try {
                        const categoryData = {};
                        data.forEach(product => {
                            // ‰ªé‰∫ßÂìÅÂêçÁß∞Êé®Êñ≠Á±ªÂà´
                            let category = 'Êú™ÂàÜÁ±ª';
                            const name = product.name || '';
                            if (name.includes('ÊâãÊú∫')) category = 'ÊâãÊú∫';
                            else if (name.includes('ÁîµËÑë') || name.includes('Á¨îËÆ∞Êú¨')) category = 'ÁîµËÑë';
                            else if (name.includes('ËÄ≥Êú∫')) category = 'ËÄ≥Êú∫';
                            else if (name.includes('ÂÖÖÁîµÂô®')) category = 'ÂÖÖÁîµÂô®';
                            else if (name.includes('Èü≥Âìç')) category = 'Èü≥Âìç';
                            else if (name.includes('Âπ≥Êùø')) category = 'Âπ≥Êùø';
                            else if (name.includes('Êï∞ÊçÆÁ∫ø')) category = 'Êï∞ÊçÆÁ∫ø';
                            else if (name.includes('ÈîÆÁõò')) category = 'ÈîÆÁõò';
                            else if (name.includes('Èº†Ê†á')) category = 'Èº†Ê†á';
                            else if (name.includes('ÊòæÁ§∫Âô®')) category = 'ÊòæÁ§∫Âô®';

                            const finalCategory = product.category || category;
                            categoryData[finalCategory] = (categoryData[finalCategory] || 0) + (product.revenue || 0);
                        });

                        charts.category.data.labels = Object.keys(categoryData);
                        charts.category.data.datasets[0].data = Object.values(categoryData);
                        charts.category.update();
                        console.log('‚úÖ ‰∫ßÂìÅÁ±ªÂà´ÂàÜÂ∏ÉÂõæÊõ¥Êñ∞ÂÆåÊàê');
                    } catch (categoryError) {
                        console.error('‚ùå Êõ¥Êñ∞‰∫ßÂìÅÁ±ªÂà´ÂàÜÂ∏ÉÂõæÂ§±Ë¥•:', categoryError);
                    }
                } else {
                    console.warn('‚ö†Ô∏è ‰∫ßÂìÅÁ±ªÂà´ÂàÜÂ∏ÉÂõæÂØπË±°‰∏çÂ≠òÂú®');
                }

                // Êõ¥Êñ∞‰∫ßÂìÅËØÑÂàÜÂàÜÂ∏ÉÂõæ - ‰ΩøÁî®avg_preference_scoreÊõø‰ª£rating
                if (charts.rating) {
                    try {
                        const ratingData = [0, 0, 0, 0, 0];
                        data.forEach(product => {
                            // Â∞Üavg_preference_scoreËΩ¨Êç¢‰∏∫1-5ÁöÑËØÑÂàÜ
                            const score = product.avg_preference_score || 0;
                            const rating = Math.min(Math.max(Math.floor(score * 5), 1), 5);
                            if (rating >= 1 && rating <= 5) {
                                ratingData[rating - 1]++;
                            }
                        });

                        charts.rating.data.datasets[0].data = ratingData;
                        charts.rating.update();
                        console.log('‚úÖ ‰∫ßÂìÅËØÑÂàÜÂàÜÂ∏ÉÂõæÊõ¥Êñ∞ÂÆåÊàê');
                    } catch (ratingError) {
                        console.error('‚ùå Êõ¥Êñ∞‰∫ßÂìÅËØÑÂàÜÂàÜÂ∏ÉÂõæÂ§±Ë¥•:', ratingError);
                    }
                } else {
                    console.warn('‚ö†Ô∏è ‰∫ßÂìÅËØÑÂàÜÂàÜÂ∏ÉÂõæÂØπË±°‰∏çÂ≠òÂú®');
                }

                console.log('‚úÖ ‰∫ßÂìÅÂõæË°®Êõ¥Êñ∞ÂÆåÊàê');
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞‰∫ßÂìÅÂõæË°®Â§±Ë¥•:', error);
                showErrorMessage('‰∫ßÂìÅÂõæË°®Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞Ë∂ãÂäøÂõæË°®
        function updateTrendChart(data) {
            try {
                console.log('Ê≠£Âú®Êõ¥Êñ∞Ë∂ãÂäøÂõæË°®ÔºåÊï∞ÊçÆ:', data);

                // Êõ¥Êñ∞Ë∂ãÂäøÂàÜÊûêÈ°µÈù¢ÁöÑÂõæË°®
                if (charts.trend) {
                    let labels = [];
                    let datasets = [];

                    // Â§ÑÁêÜÊ¥ªË∑ÉÁî®Êà∑Êï∞ÊçÆ
                    if (data.active_users && Array.isArray(data.active_users) && data.active_users.length > 0) {
                        labels = data.active_users.map(item => {
                            // Ê†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫
                            const date = new Date(item.date);
                            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                        });

                        datasets.push({
                            label: 'Ê¥ªË∑ÉÁî®Êà∑',
                            data: data.active_users.map(item => item.value || 0),
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#36A2EB',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        });

                        console.log('Ê¥ªË∑ÉÁî®Êà∑Êï∞ÊçÆÁÇπ:', data.active_users.map(item => item.value || 0));
                    }

                    // Â§ÑÁêÜËÆ¢ÂçïÊï∞ÊçÆ
                    if (data.orders && Array.isArray(data.orders) && data.orders.length > 0) {
                        // Â¶ÇÊûúËøòÊ≤°ÊúâÊ†áÁ≠æÔºå‰ΩøÁî®ËÆ¢ÂçïÊï∞ÊçÆÁöÑÊó•Êúü
                        if (labels.length === 0) {
                            labels = data.orders.map(item => {
                                const date = new Date(item.date);
                                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                            });
                        }

                        datasets.push({
                            label: 'ËÆ¢ÂçïÊï∞',
                            data: data.orders.map(item => item.value || 0),
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#FF6384',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        });

                        console.log('ËÆ¢ÂçïÊï∞ÊçÆÁÇπ:', data.orders.map(item => item.value || 0));
                    }

                    // Â§ÑÁêÜÊî∂ÂÖ•Êï∞ÊçÆ
                    if (data.revenue && Array.isArray(data.revenue) && data.revenue.length > 0) {
                        // Â¶ÇÊûúËøòÊ≤°ÊúâÊ†áÁ≠æÔºå‰ΩøÁî®Êî∂ÂÖ•Êï∞ÊçÆÁöÑÊó•Êúü
                        if (labels.length === 0) {
                            labels = data.revenue.map(item => {
                                const date = new Date(item.date);
                                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                            });
                        }

                        datasets.push({
                            label: 'Êî∂ÂÖ• (¬•)',
                            data: data.revenue.map(item => item.value || 0),
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#28a745',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y1'
                        });

                        // Ê∑ªÂä†Á¨¨‰∫å‰∏™YËΩ¥Áî®‰∫éÊî∂ÂÖ•
                        if (!charts.trend.options.scales.y1) {
                            charts.trend.options.scales.y1 = {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Êî∂ÂÖ• (¬•)',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false,
                                    color: 'rgba(40, 167, 69, 0.1)'
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                }
                            };
                        }

                        console.log('Êî∂ÂÖ•Êï∞ÊçÆÁÇπ:', data.revenue.map(item => item.value || 0));
                    }

                    // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÊï∞ÊçÆÔºåÂàõÂª∫Á§∫‰æãÊï∞ÊçÆ
                    if (labels.length === 0 || datasets.length === 0) {
                        console.log('Ê≤°ÊúâË∂ãÂäøÊï∞ÊçÆÔºåÂàõÂª∫Á§∫‰æãÊï∞ÊçÆ');
                        const today = new Date();
                        labels = [];
                        const sampleData = [];

                        for (let i = 6; i >= 0; i--) {
                            const date = new Date(today);
                            date.setDate(date.getDate() - i);
                            labels.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                            sampleData.push(Math.floor(Math.random() * 100) + 50);
                        }

                        datasets = [{
                            label: 'Ê¥ªË∑ÉÁî®Êà∑',
                            data: sampleData,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#36A2EB',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }];
                    }

                    // Êõ¥Êñ∞ÂõæË°®Êï∞ÊçÆ
                    charts.trend.data.labels = labels;
                    charts.trend.data.datasets = datasets;
                    charts.trend.update('active');

                    console.log('‚úÖ Ë∂ãÂäøÂõæË°®Êõ¥Êñ∞ÂÆåÊàêÔºåÊ†áÁ≠æÊï∞:', labels.length, 'Êï∞ÊçÆÈõÜÊï∞:', datasets.length);
                }

                // Êõ¥Êñ∞‰∫ßÂìÅÊÄßËÉΩÈ°µÈù¢ÁöÑ‰∫ßÂìÅÈîÄÂîÆË∂ãÂäøÂõæË°®
                if (charts.productTrend) {
                    try {
                        console.log('Ê≠£Âú®Êõ¥Êñ∞‰∫ßÂìÅÈîÄÂîÆË∂ãÂäøÂõæË°®ÔºåÂéüÂßãÊï∞ÊçÆ:', data);

                        // ‰ΩøÁî®Ë∂ãÂäøÊï∞ÊçÆÊõ¥Êñ∞‰∫ßÂìÅÈîÄÂîÆË∂ãÂäøÂõæ
                        const labels = [];
                        const salesData = [];
                        const revenueData = [];

                        // Â¶ÇÊûúÊúâËÆ¢ÂçïÊï∞ÊçÆÔºå‰ΩøÁî®ËÆ¢ÂçïÊï∞ÊçÆ‰Ωú‰∏∫ÈîÄÂîÆË∂ãÂäø
                        if (data.orders && Array.isArray(data.orders)) {
                            console.log('Â§ÑÁêÜËÆ¢ÂçïÊï∞ÊçÆ:', data.orders);
                            data.orders.forEach(item => {
                                labels.push(item.date);
                                salesData.push(item.value || 0);
                            });
                        }

                        // Â¶ÇÊûúÊúâÊî∂ÂÖ•Êï∞ÊçÆÔºåÊ∑ªÂä†Êî∂ÂÖ•Ë∂ãÂäø
                        if (data.revenue && Array.isArray(data.revenue)) {
                            console.log('Â§ÑÁêÜÊî∂ÂÖ•Êï∞ÊçÆ:', data.revenue);
                            data.revenue.forEach((item, index) => {
                                if (index < labels.length) {
                                    revenueData.push(item.value || 0);
                                } else if (labels.length === 0) {
                                    labels.push(item.date);
                                    revenueData.push(item.value || 0);
                                }
                            });
                        }

                        // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºåÂàõÂª∫Á§∫‰æãÊï∞ÊçÆ‰ª•Á°Æ‰øùÂõæË°®ÊòæÁ§∫
                        if (labels.length === 0) {
                            console.log('Ê≤°ÊúâË∂ãÂäøÊï∞ÊçÆÔºåÂàõÂª∫Á§∫‰æãÊï∞ÊçÆ');
                            const today = new Date();
                            for (let i = 6; i >= 0; i--) {
                                const date = new Date(today);
                                date.setDate(date.getDate() - i);
                                labels.push(date.toISOString().split('T')[0]);
                                salesData.push(Math.floor(Math.random() * 50) + 10);
                                revenueData.push(Math.floor(Math.random() * 5000) + 1000);
                            }
                        }

                        console.log('ÂõæË°®Ê†áÁ≠æ:', labels);
                        console.log('ÈîÄÂîÆÊï∞ÊçÆ:', salesData);
                        console.log('Êî∂ÂÖ•Êï∞ÊçÆ:', revenueData);

                        // Êõ¥Êñ∞ÂõæË°®Êï∞ÊçÆ
                        charts.productTrend.data.labels = labels;
                        charts.productTrend.data.datasets = [];

                        if (salesData.length > 0) {
                            charts.productTrend.data.datasets.push({
                                label: 'ÈîÄÂîÆÈáè',
                                data: salesData,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                fill: false,
                                tension: 0.4,
                                pointBackgroundColor: '#28a745',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4
                            });
                        }

                        if (revenueData.length > 0) {
                            charts.productTrend.data.datasets.push({
                                label: 'Êî∂ÂÖ•Ë∂ãÂäø (¬•)',
                                data: revenueData,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                fill: false,
                                tension: 0.4,
                                pointBackgroundColor: '#007bff',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                yAxisID: 'y1'
                            });

                            // Ê∑ªÂä†Á¨¨‰∫å‰∏™YËΩ¥Áî®‰∫éÊî∂ÂÖ•
                            charts.productTrend.options.scales.y1 = {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Êî∂ÂÖ• (¬•)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                    color: 'rgba(0, 123, 255, 0.1)'
                                }
                            };
                        }

                        charts.productTrend.update('active');
                        console.log('‚úÖ ‰∫ßÂìÅÈîÄÂîÆË∂ãÂäøÂõæË°®Êõ¥Êñ∞ÂÆåÊàêÔºåÊï∞ÊçÆÈõÜÊï∞Èáè:', charts.productTrend.data.datasets.length);
                    } catch (productTrendError) {
                        console.error('‚ùå Êõ¥Êñ∞‰∫ßÂìÅÈîÄÂîÆË∂ãÂäøÂõæË°®Â§±Ë¥•:', productTrendError);
                    }
                }
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞Ë∂ãÂäøÂõæË°®Â§±Ë¥•:', error);
            }
        }

        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        function showErrorMessage(message) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÈîôËØØÊèêÁ§∫ÂÖÉÁ¥†
            let errorElement = document.getElementById('error-message');

            // Â¶ÇÊûú‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = 'error-message';
                errorElement.className = 'alert alert-danger alert-dismissible fade show';
                errorElement.style.position = 'fixed';
                errorElement.style.top = '20px';
                errorElement.style.right = '20px';
                errorElement.style.zIndex = '9999';
                errorElement.style.maxWidth = '400px';

                // Ê∑ªÂä†ÂÖ≥Èó≠ÊåâÈíÆ
                const closeButton = document.createElement('button');
                closeButton.type = 'button';
                closeButton.className = 'btn-close';
                closeButton.setAttribute('data-bs-dismiss', 'alert');
                closeButton.setAttribute('aria-label', 'ÂÖ≥Èó≠');
                errorElement.appendChild(closeButton);

                document.body.appendChild(errorElement);
            }

            // ËÆæÁΩÆÈîôËØØÊ∂àÊÅØÂÜÖÂÆπ
            errorElement.innerHTML = `
                <strong>ÈîôËØØ!</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="ÂÖ≥Èó≠"></button>
            `;

            // 5ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
            setTimeout(() => {
                if (errorElement && errorElement.parentNode) {
                    errorElement.parentNode.removeChild(errorElement);
                }
            }, 5000);
        }

    // --- Admin Chat Implementation ---
    const AdminChat = {
        activeSessionId: null,
        sessions: {},

        init() {
            this.cacheDOM();
            this.bindEvents();
            this.renderSidebar();
        },

        cacheDOM() {
            this.sidebarList = document.getElementById('cs-session-list');
            this.chatBody = document.getElementById('cs-messages');
            this.input = document.getElementById('cs-input');
            this.sendBtn = document.getElementById('cs-send-btn');
            this.totalActiveBadge = document.getElementById('cs-total-active');
            this.chatInterface = document.getElementById('cs-chat-interface');
            this.emptyState = document.getElementById('cs-empty-state');
            this.currentName = document.getElementById('cs-current-name');
            this.currentId = document.getElementById('cs-current-id');
            this.currentAvatar = document.getElementById('cs-current-avatar');
            this.currentStatus = document.getElementById('cs-current-status');
        },

        bindEvents() {
            if (this.sendBtn) {
                const newBtn = this.sendBtn.cloneNode(true);
                this.sendBtn.parentNode.replaceChild(newBtn, this.sendBtn);
                this.sendBtn = newBtn;
                this.sendBtn.addEventListener('click', () => this.sendMessage());
            }
            if (this.input) {
                const newInput = this.input.cloneNode(true);
                this.input.parentNode.replaceChild(newInput, this.input);
                this.input = newInput;
                this.input.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.sendMessage(); });
            }
        },

        handleMessage(msg) {
            if (msg.type === 'clients') {
                this.updateSessionList(msg.clients);
            } else if (msg.type === 'message' || msg.type === 'question') {
                this.addMessage(msg.sessionId, msg, 'user');
            } else if (msg.type === 'reply') {
                this.addMessage(msg.sessionId, msg, 'admin');
            }
        },

        updateSessionList(clients) {
            if (!Array.isArray(clients)) return;
            clients.forEach(c => {
                if (!this.sessions[c.sessionId]) {
                    this.sessions[c.sessionId] = {
                        user: c.user || { username: 'Guest' },
                        messages: [],
                        unread: 0,
                        lastActive: Date.now()
                    };
                } else {
                    this.sessions[c.sessionId].user = c.user || this.sessions[c.sessionId].user;
                }
            });
            this.renderSidebar();
        },

        addMessage(sid, msg, sender) {
            if (!this.sessions[sid]) {
                this.sessions[sid] = { user: msg.user || { username: 'Guest' }, messages: [], unread: 0, lastActive: Date.now() };
            }
            const session = this.sessions[sid];
            session.messages.push({ content: msg.message, sender, time: msg.timestamp || new Date().toISOString() });
            session.lastActive = Date.now();
            if (this.activeSessionId === sid) {
                this.appendChatBubble(msg.message, sender, msg.timestamp);
                this.scrollToBottom();
            } else {
                session.unread++;
                this.renderSidebar();
            }
        },

        sendMessage() {
            if (!this.activeSessionId) return;
            const text = (this.input?.value || '').trim();
            if (!text) return;
            if (adminWs && adminWs.readyState === WebSocket.OPEN) {
                adminWs.send(JSON.stringify({ type: 'reply', sessionId: this.activeSessionId, message: text }));
                this.input.value = '';
            }
        },

        selectSession(sid) {
            this.activeSessionId = sid;
            const session = this.sessions[sid];
            if (session) {
                session.unread = 0;
                this.renderSidebar();
                this.renderChat(session);
                this.loadHistory(sid);
            }
        },

        async loadHistory(sid) {
            try {
                const res = await fetch(`/admin/api/chat/history/${sid}`);
                const data = await res.json();
                if (data.ok && data.history) {
                    const session = this.sessions[sid];
                    session.messages = data.history.map(h => ({ content: h.content, sender: h.sender, time: h.time }));
                    this.renderChat(session);
                }
            } catch (e) { console.error('Failed to load history', e); }
        },

        renderSidebar() {
            if (!this.sidebarList) return;
            this.sidebarList.innerHTML = '';
            const sorted = Object.keys(this.sessions).sort((a, b) => this.sessions[b].lastActive - this.sessions[a].lastActive);
            if (this.totalActiveBadge) this.totalActiveBadge.textContent = sorted.length;
            sorted.forEach(sid => {
                const s = this.sessions[sid];
                const item = document.createElement('div');
                item.className = `cs-session-item ${this.activeSessionId === sid ? 'active' : ''}`;
                item.onclick = () => this.selectSession(sid);
                const name = s.user.username || s.user.email || sid.slice(0,6);
                const lastMsg = s.messages.length ? s.messages[s.messages.length - 1].content : 'ÊöÇÊó†Ê∂àÊÅØ';
                const avatarText = (name || 'U').slice(0,1).toUpperCase();
                item.innerHTML = `
                    <div class="cs-session-avatar">${avatarText}</div>
                    <div class="cs-session-info">
                        <div class="cs-session-name">${name}</div>
                        <div class="cs-session-preview">${lastMsg}</div>
                    </div>
                    ${s.unread>0?`<div class="cs-unread-badge">${s.unread}</div>`:''}
                `;
                this.sidebarList.appendChild(item);
            });
        },

        renderChat(session) {
            if (!this.chatBody) return;
            if (this.emptyState) this.emptyState.style.display = 'none';
            if (this.chatInterface) this.chatInterface.style.display = 'flex';
            this.chatBody.innerHTML = '';
            const display = session.user.username || session.user.email || this.activeSessionId;
            if (this.currentName) this.currentName.textContent = display;
            if (this.currentId) this.currentId.textContent = this.activeSessionId;
            if (this.currentAvatar) this.currentAvatar.textContent = (display||'U').slice(0,1).toUpperCase();
            session.messages.forEach(m => this.appendChatBubble(m.content, m.sender, m.time));
            this.scrollToBottom();
        },

        appendChatBubble(text, sender, time) {
            if (!this.chatBody) return;
            const isMe = sender === 'admin';
            const row = document.createElement('div');
            row.className = `cs-msg ${isMe ? 'me' : 'other'}`;
            const content = document.createElement('div');
            content.className = 'cs-msg-content';
            content.textContent = text;
            const t = document.createElement('div');
            t.className = 'cs-msg-time';
            t.textContent = this.formatTime(time);
            row.appendChild(content);
            row.appendChild(t);
            this.chatBody.appendChild(row);
        },

        formatTime(t) { if (!t) return ''; const d = new Date(t); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); },
        scrollToBottom() { if (this.chatBody) this.chatBody.scrollTop = this.chatBody.scrollHeight; }
    };

    // Overwrite existing functions
    function connectAdminWs() {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        adminWs = new WebSocket(`${proto}://${location.host}/admin/ws`);
        adminWs.onmessage = function (ev) {
            let msg; try { msg = JSON.parse(ev.data); } catch (_) { msg = { type: 'raw', data: ev.data }; }
            
            if (AdminChat) AdminChat.handleMessage(msg);

            if (msg.type === 'metrics') updateMetrics(msg.metrics);
            if (msg.type === 'clients') updateClients(msg.clients);
            if (msg.type === 'log') { appendLog(msg.log); if (msg.log && msg.log.level === 'error') appendErrorLog(msg.log.message || 'ERROR'); }
            if (msg.type === 'server_log') appendServerLog(msg.data || msg);
            if (msg.type === 'error_log') appendErrorLog(msg.data);
            if (msg.type === 'app_error') appendErrorLog(msg.data);
            if (msg.type === 'log_init' && Array.isArray(msg.logs)) { msg.logs.forEach(appendLog); }
        };
        // Reconnection logic could be added here
        adminWs.onclose = function() {
            setTimeout(connectAdminWs, 3000);
        };
    }

    function initializeCustomerService() {
        AdminChat.init();
    }
    </script>
